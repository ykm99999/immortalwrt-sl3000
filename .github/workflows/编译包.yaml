name: OpenWrt SDK Build

on:
  workflow_dispatch:

env:
  SDK_URL: https://downloads.openwrt.org/releases/23.05.0/targets/mediatek/mt7981/openwrt-sdk-23.05.0-mediatek-mt7981_gcc-12.3.0_musl.Linux-x86_64.tar.xz
  CONFIG_FILE: ç¼–è¯‘åŒ….config
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout this repo
      uses: actions/checkout@v3

    - name: Free disk space
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/lib/jvm
        sudo docker image prune --all --force
        sudo apt-get clean

    - name: Build Docker image
      run: docker build -t openwrt-sdk .

    - name: Run SDK container
      run: |
        docker run --rm -v ${{ github.workspace }}:/workdir openwrt-sdk bash -c "
          set -e
          cd /sdk
          echo 'ðŸ“¦ ä¸‹è½½ OpenWrt SDK...'
          wget -q $SDK_URL -O sdk.tar.xz
          tar -xf sdk.tar.xz
          cd openwrt-sdk-*
          cp /workdir/${{ env.CONFIG_FILE }} .config
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          make defconfig
          make package/luci-app-ssr-plus/compile -j$(nproc) V=s
        "

    - name: Upload compiled packages
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt_packages
        path: sdk/openwrt-sdk-*/bin/packages
