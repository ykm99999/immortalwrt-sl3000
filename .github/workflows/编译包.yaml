name: Build Packages for SL3000

on:
  workflow_dispatch:
    inputs:
      clean_build:
        description: 'Clean build'
        type: boolean
        default: false

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          clang \
          cmake \
          git \
          libssl-dev \
          ncurses-dev \
          python3 \
          python3-pip \
          python3-setuptools \
          python3-venv \
          unzip \
          wget \
          curl \
          file \
          rsync \
          bc \
          subversion \
          quilt \
          libelf-dev \
          patchelf \
          gawk \
          flex \
          bison \
          zlib1g-dev

    - name: Clone source
      run: |
        git clone --depth=1 https://github.com/padavanonly/immortalwrt-mt798x-24.10 -b 2410 immortalwrt

    - name: Clean build (optional)
      if: inputs.clean_build
      working-directory: immortalwrt
      run: |
        make distclean || true
        git clean -fdx

    - name: Setup environment
      working-directory: immortalwrt
      run: |
        # 更新并安装所有 feeds
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        # 基础配置
        cat > .config << EOF
CONFIG_TARGET_mediatek=y
CONFIG_TARGET_mediatek_mt7981=y
CONFIG_TARGET_mediatek_mt7981_DEVICE_sl_3000-emmc=y
CONFIG_PACKAGE_luci-app-docker=y
CONFIG_PACKAGE_luci-app-passwall2=y
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-base=y
CONFIG_PACKAGE_luci-compat=y
CONFIG_PACKAGE_docker=y
CONFIG_PACKAGE_dockerd=y
CONFIG_PACKAGE_containerd=y
CONFIG_PACKAGE_runc=y
CONFIG_PACKAGE_tini=y
CONFIG_PACKAGE_libnetwork=y
CONFIG_PACKAGE_libdevmapper=y
CONFIG_BRIDGE=y
CONFIG_IPV6=y
CONFIG_KERNEL_CGROUP_DEVICE=y
CONFIG_KERNEL_CGROUP_FREEZER=y
CONFIG_KERNEL_EXT4_FS_POSIX_ACL=y
CONFIG_KERNEL_EXT4_FS_SECURITY=y
CONFIG_KERNEL_FS_POSIX_ACL=y
CONFIG_KERNEL_CGROUPS=y
CONFIG_KERNEL_NAMESPACES=y
EOF
        
        # 应用配置并检查依赖
        make defconfig
        make tools/install -j$(nproc)
        make toolchain/install -j$(nproc)

    - name: Download sources
      working-directory: immortalwrt
      run: |
        make download -j$(nproc)
        # 检查下载完整性
        find dl/ -name '*.tmp' -delete
        make -j1 download CHECK=1

    - name: Build luci-app-docker with diagnostics
      working-directory: immortalwrt
      run: |
        echo "=== 开始编译 luci-app-docker ==="
        
        # 清理可能的旧编译结果
        make package/luci-app-docker/clean
        
        # 检查依赖关系
        echo "=== 检查依赖关系 ==="
        make package/luci-app-docker/check V=s || true
        
        # 编译并保存详细日志
        if ! make package/luci-app-docker/compile -j1 V=sc 2>&1 | tee luci-app-docker-build.log; then
          echo "=== luci-app-docker 编译失败 ==="
          echo "=== 最后 50 行错误日志 ==="
          tail -50 luci-app-docker-build.log
          
          # 尝试诊断问题
          echo "=== 检查缺失的依赖 ==="
          find staging_dir/ -name "*.pc" | head -10
          echo "=== 检查工具链 ==="
          ls -la staging_dir/toolchain-*/
          
          exit 1
        fi
        
        echo "=== luci-app-docker 编译成功 ==="

    - name: Build luci-app-passwall2 with diagnostics
      working-directory: immortalwrt
      run: |
        echo "=== 开始编译 luci-app-passwall2 ==="
        
        # 清理可能的旧编译结果
        make package/luci-app-passwall2/clean
        
        # 检查依赖关系
        echo "=== 检查依赖关系 ==="
        make package/luci-app-passwall2/check V=s || true
        
        # 编译并保存详细日志
        if ! make package/luci-app-passwall2/compile -j1 V=sc 2>&1 | tee luci-app-passwall2-build.log; then
          echo "=== luci-app-passwall2 编译失败 ==="
          echo "=== 最后 50 行错误日志 ==="
          tail -50 luci-app-passwall2-build.log
          exit 1
        fi
        
        echo "=== luci-app-passwall2 编译成功 ==="

    - name: Collect build artifacts
      working-directory: immortalwrt
      run: |
        echo "=== 生成的软件包 ==="
        find bin/ -name "*.ipk" -type f | grep -E "(luci-app-docker|luci-app-passwall2)" || true
        
        echo "=== 所有软件包列表 ==="
        find bin/ -name "*.ipk" -type f | head -20

    - name: Upload packages
      uses: actions/upload-artifact@v4
      with:
        name: SL3000-Packages
        path: |
          immortalwrt/bin/packages/**/*.ipk
          immortalwrt/*build.log
        retention-days: 7

    - name: Upload build logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: Build-Failure-Logs
        path: |
          immortalwrt/*build.log
          immortalwrt/build_dir/**/log*
        retention-days: 3
