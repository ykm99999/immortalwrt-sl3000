name: 司洛SL-3000 极简编译

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: 安装依赖
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libssl-dev libncurses5-dev gawk gettext

    - name: 克隆源码
      run: |
        git clone --depth=1 https://github.com/padavanonly/immortalwrt-mt798x openwrt

    - name: 配置和编译
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        # 极简配置
        echo "CONFIG_TARGET_mediatek_mt7981=y" > .config
        echo "CONFIG_TARGET_mediatek_mt7981_DEVICE_cmcc_rax3000m-nand-ubootmod=y" >> .config
        echo "CONFIG_PACKAGE_luci-base=y" >> .config
        echo "CONFIG_PACKAGE_wpad-basic-wolfssl=y" >> .config
        
        make defconfig
        make download -j2
        make -j2

    - name: 上传固件
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: SL3000-固件
        path: openwrt/bin/targets/**/*
