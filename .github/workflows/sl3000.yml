name: Build Siluo SL-3000 ImmortalWrt 24.10

on:
  workflow_dispatch:

env:
  CCACHE_DIR: ${{ github.workspace }}/ccache

jobs:
  build:
    name: Build ImmortalWrt MT7981 Siluo SL3000
    runs-on: ubuntu-22.04
    timeout-minutes: 180

    steps:
    - name: Checkout ImmortalWrt 24.10 source
      run: |
        git clone https://github.com/immortalwrt/immortalwrt.git openwrt
        cd openwrt
        git checkout openwrt-24.10

    - name: Cache ccache
      uses: actions/cache@v3
      with:
        path: ccache
        key: ${{ runner.os }}-ccache-${{ hashFiles('openwrt/.config') }}
        restore-keys: |
          ${{ runner.os }}-ccache-

    - name: Add custom DTS
      run: |
        mkdir -p openwrt/target/linux/mediatek/dts/
        curl -L https://raw.githubusercontent.com/ykm99999/immortalwrt-sl3000/main/target/linux/mediatek/dts/mt7981-siluo-sl3000.dts -o openwrt/target/linux/mediatek/dts/mt7981-siluo-sl3000.dts

    - name: Add custom mk
      run: |
        mkdir -p openwrt/target/linux/mediatek/image/
        curl -L https://raw.githubusercontent.com/ykm99999/immortalwrt-sl3000/main/target/linux/mediatek/image/mt7981.mk -o openwrt/target/linux/mediatek/image/mt7981.mk

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3 python3-setuptools rsync unzip zlib1g-dev file wget ccache cmake libjson-c-dev

    - name: Setup ccache
      run: |
        echo "CCACHE_DIR=$GITHUB_WORKSPACE/ccache" >> $GITHUB_ENV
        echo "/usr/lib/ccache" >> $GITHUB_PATH

    - name: Update feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Configure target
      run: |
        cd openwrt
        rm -f .config
        
        # 使用更简单的方法创建配置文件
        {
          echo "CONFIG_TARGET_mediatek=y"
          echo "CONFIG_TARGET_mediatek_mt7981=y"
          echo "CONFIG_TARGET_mediatek_mt7981_DEVICE_siluo_sl3000=y"
          echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y"
          echo "CONFIG_TARGET_IMAGES_GZIP=y"
          echo "CONFIG_LUCI_LANG_zh-cn=y"
          echo "CONFIG_LINUX_6_6=y"
          echo "CONFIG_PACKAGE_luci=y"
          echo "CONFIG_PACKAGE_luci-i18n-base-zh-cn=y"
          echo "CONFIG_PACKAGE_luci-theme-bootstrap=y"
          echo "CONFIG_PACKAGE_luci-app-turboacc=y"
          echo "CONFIG_PACKAGE_luci-i18n-turboacc-zh-cn=y"
          echo "CONFIG_PACKAGE_kmod-shortcut-fe=y"
          echo "CONFIG_PACKAGE_kmod-shortcut-fe-cm=y"
          echo "CONFIG_PACKAGE_kmod-nft-fullcone=y"
          echo "CONFIG_PACKAGE_kmod-tcp-bbr=y"
          echo "CONFIG_PACKAGE_kmod-mt7981-wifi=y"
          echo "CONFIG_PACKAGE_luci-app-wireless=y"
          echo "CONFIG_PACKAGE_luci-i18n-wireless-zh-cn=y"
          echo "CONFIG_PACKAGE_wpad-openssl=y"
          echo "CONFIG_PACKAGE_hostapd=y"
          echo "CONFIG_PACKAGE_iw=y"
          echo "CONFIG_PACKAGE_wireless-tools=y"
          echo "CONFIG_PACKAGE_luci-app-firewall=y"
          echo "CONFIG_PACKAGE_luci-app-upnp=y"
          echo "CONFIG_PACKAGE_luci-app-ddns=y"
          echo "CONFIG_PACKAGE_luci-app-attendedsysupgrade=y"
          echo "CONFIG_PACKAGE_luci-app-opkg=y"
          echo "CONFIG_CCACHE=y"
        } > .config
        
        make defconfig

    - name: Build firmware
      run: |
        cd openwrt
        make -j$(($(nproc) + 1)) CCACHE=1

    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: siluo-sl3000-firmware
        path: openwrt/bin/targets/mediatek/mt7981/*
