name: SL3000 Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Verify Config File
      run: |
        echo "=== Checking for Configuration Files ==="
        ls -la *.config || echo "No config files found"
        if [ -f "sl3000.config" ]; then
          echo "Found sl3000.config file"
          cp sl3000.config .config
          echo "Copied sl3000.config to .config"
        else
          echo "Error: sl3000.config file not found!"
          echo "Available files:"
          ls -la
          exit 1
        fi

    - name: Initial Disk Cleanup
      run: |
        echo "=== Starting Disk Space Optimization ==="
        sudo apt-get autoremove -y --purge
        sudo apt-get clean
        sudo rm -rf /var/lib/apt/lists/*
        sudo rm -rf /usr/share/doc/* /usr/share/man/* /usr/share/locale/*
        sudo journalctl --vacuum-time=1h
        sudo find /var/log -type f -name "*.log" -exec truncate -s 0 {} \;
        sudo rm -rf /tmp/*
        echo "=== Disk Space After Initial Cleanup ==="
        df -h

    - name: Install Minimal Dependencies
      run: |
        echo "=== Installing Minimal Dependencies ==="
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          build-essential \
          libssl-dev \
          libncurses5-dev \
          gawk \
          gettext \
          unzip \
          python3 \
          subversion \
          git \
          wget \
          curl \
          file \
          rsync
        sudo apt-get clean

    - name: Detect Source Branch
      run: |
        echo "=== Detecting Available Branches ==="
        # 获取仓库的默认分支
        git ls-remote --heads https://github.com/padavanonly/immortalwrt-mt798x | grep -E "refs/heads/(main|master|openwrt-21.02)" | head -5
        # 设置默认分支变量
        if git ls-remote --exit-code --heads https://github.com/padavanonly/immortalwrt-mt798x main > /dev/null 2>&1; then
          echo "BRANCH=main" >> $GITHUB_ENV
        elif git ls-remote --exit-code --heads https://github.com/padavanonly/immortalwrt-mt798x master > /dev/null 2>&1; then
          echo "BRANCH=master" >> $GITHUB_ENV
        else
          # 尝试获取第一个可用分支
          FIRST_BRANCH=$(git ls-remote --heads https://github.com/padavanonly/immortalwrt-mt798x | head -1 | awk -F'/' '{print $3}')
          echo "BRANCH=$FIRST_BRANCH" >> $GITHUB_ENV
        fi
        echo "Using branch: $BRANCH"

    - name: Clone Source with Space Optimization
      run: |
        echo "=== Cloning Source with Space Optimization ==="
        echo "Using branch: ${{ env.BRANCH }}"
        git clone \
          --depth=1 \
          --single-branch \
          --branch ${{ env.BRANCH }} \
          --filter=blob:none \
          https://github.com/padavanonly/immortalwrt-mt798x \
          openwrt
        
        cd openwrt
        # 清理git历史节省空间
        git gc --aggressive --prune=all
        
        echo "=== Source Code Size ==="
        du -sh .

    - name: Remove Problematic Feeds
      run: |
        cd openwrt
        echo "=== Cleaning Feeds Configuration ==="
        # 完全移除有问题的feeds
        sed -i '/modemfeed/d' feeds.conf.default
        sed -i '/kiddin9/d' feeds.conf.default

    - name: Setup Feeds
      run: |
        cd openwrt
        echo "=== Setting up Feeds ==="
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Apply Configuration
      run: |
        cd openwrt
        echo "=== Applying Configuration ==="
        # 从仓库根目录复制配置文件
        cp ../.config .config
        make defconfig

    - name: Download with Cache Optimization
      run: |
        cd openwrt
        echo "=== Downloading Packages ==="
        
        # 创建下载缓存目录
        mkdir -p /tmp/dl-cache
        [ -d dl ] && rm -rf dl
        ln -sf /tmp/dl-cache dl
        
        # 使用更少的并行下载任务
        make download -j1

    - name: Compile with Memory Optimization
      run: |
        cd openwrt
        echo "=== Starting Compilation ==="
        
        # 显示编译前磁盘空间
        echo "=== Disk Space Before Compilation ==="
        df -h
        
        # 设置编译优化参数
        export FORCE_UNSAFE_CONFIGURE=1
        
        # 分步骤编译以避免内存和磁盘压力
        echo "Step 1: Compiling toolchain..."
        make toolchain/install -j2
        
        echo "Step 2: Compiling kernel..."
        make target/linux/compile -j2
        
        echo "Step 3: Compiling packages..."
        make package/compile -j2
        
        echo "Step 4: Creating final image..."
        make -j2
        
        echo "=== Disk Space After Compilation ==="
        df -h

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sl3000-firmware
        path: openwrt/bin/targets/**/*
        retention-days: 7
