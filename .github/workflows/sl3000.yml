name: å¸æ´›SL-3000 EMMC - æè‡´ä¼˜åŒ–ç‰ˆ

on:
  repository_dispatch:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x-24.10
  REPO_BRANCH: 2410
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: sl3000.config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    
    # ä½¿ç”¨æ›´å¤§çš„runnerï¼ˆå¦‚æœæœ‰ï¼‰
    # runs-on: [self-hosted, large, x64]
    
    strategy:
      matrix:
        # åˆ†é˜¶æ®µæ„å»ºï¼Œå‡å°‘å†…å­˜å‹åŠ›
        stage: [prepare, compile]
    timeout-minutes: 240

    steps:
    - name: æ£€æŸ¥å·¥ä½œç©ºé—´
      run: |
        echo "åˆå§‹ç£ç›˜ç©ºé—´:"
        df -h
        echo "å†…å­˜ä¿¡æ¯:"
        free -h

    - name: Checkout (æé™ä¼˜åŒ–)
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
        sparse-checkout: |
          ${{ env.FEEDS_CONF }}
          ${{ env.CONFIG_FILE }}
          ${{ env.DIY_P1_SH }}
          ${{ env.DIY_P2_SH }}
          files/
        sparse-checkout-cone-mode: false

    - name: ç³»ç»Ÿçº§æ·±åº¦æ¸…ç†
      run: |
        echo "=== æ·±åº¦ç³»ç»Ÿæ¸…ç† ==="
        # åœæ­¢ä¸å¿…è¦çš„æœåŠ¡
        sudo systemctl stop docker containerd snapd || true
        
        # æ¸…ç†æ‰€æœ‰ç¼“å­˜å’Œä¸´æ—¶æ–‡ä»¶
        sudo sync
        sudo echo 3 > /proc/sys/vm/drop_caches
        
        # å½»åº•æ¸…ç†åŒ…ç®¡ç†
        sudo dpkg --purge $(dpkg -l | grep "^rc" | awk '{print $2}') 2>/dev/null || true
        sudo apt-get autoremove --purge -y
        sudo apt-get clean
        
        # æ¸…ç†æ‰€æœ‰å¯èƒ½çš„å¤§ç›®å½•
        sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/lib/android /opt/hostedtoolcache
        sudo rm -rf /var/lib/docker /var/lib/snapd /usr/lib/firefox /usr/lib/google-cloud-sdk
        sudo rm -rf /usr/local/lib/node_modules /opt/microsoft /usr/share/swift
        
        # æ¸…ç†æ—¥å¿—å’Œä¸´æ—¶æ–‡ä»¶
        sudo find /var/log -type f -exec truncate -s 0 {} \;
        sudo find /tmp -type f -atime +1 -delete 2>/dev/null || true
        
        echo "æ¸…ç†åç©ºé—´:"
        df -h
        free -h

    - name: é…ç½®åˆ†å±‚ç¼“å­˜
      uses: actions/cache@v3
      with:
        path: |
          ~/.ccache
          /workdir/openwrt/dl
          /workdir/openwrt/build_dir/target-*
          /workdir/openwrt/staging_dir/target-*
        key: ${{ runner.os }}-openwrt-${{ hashFiles('**/.config', '**/feeds.conf.default') }}-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-openwrt-${{ hashFiles('**/.config', '**/feeds.conf.default') }}-
          ${{ runner.os }}-openwrt-

    - name: æ™ºèƒ½æºç ç®¡ç†
      working-directory: /workdir
      run: |
        echo "=== æ™ºèƒ½æºç ç®¡ç† ==="
        if [ -d "openwrt" ] && [ -f "openwrt/.git/index" ]; then
          echo "ä½¿ç”¨ç°æœ‰ä»“åº“å¹¶å¢é‡æ›´æ–°"
          cd openwrt
          git config core.compression 0
          git config http.postBuffer 524288000
          git fetch --depth=1 origin $REPO_BRANCH
          git reset --hard origin/$REPO_BRANCH
          git clean -fdx
        else
          echo "å…¨æ–°å…‹éš†ï¼ˆä¼˜åŒ–ç‰ˆï¼‰"
          rm -rf openwrt
          git clone \
            --depth=1 \
            --branch $REPO_BRANCH \
            --single-branch \
            --filter=blob:none \
            --sparse \
            $REPO_URL openwrt
          cd openwrt
          git sparse-checkout set --no-cone "/*" "!/.*"
        fi
        
        # åˆ›å»ºå·¥ä½œåŒºé“¾æ¥
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
        echo "æºç ç›®å½•ä¿¡æ¯:"
        du -sh .git . | head -5

    - name: æœ€å°åŒ–ä¾èµ–å®‰è£…
      run: |
        echo "=== æœ€å°åŒ–ä¾èµ–å®‰è£… ==="
        # ä»…å®‰è£…ç»å¯¹å¿…è¦çš„åŒ…
        essential_packages=(
          build-essential
          ccache
          gcc
          g++
          make
          cmake
          ninja-build
          git
          libssl-dev
          libncurses5-dev
          zlib1g-dev
          gawk
          gettext
          flex
          bison
          python3
          rsync
          unzip
          wget
        )
        
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends "${essential_packages[@]}"
        sudo apt-get clean
        sudo rm -rf /var/lib/apt/lists/*

    - name: ç¯å¢ƒä¼˜åŒ–é…ç½®
      run: |
        echo "=== ç¯å¢ƒä¼˜åŒ–é…ç½® ==="
        # é…ç½®ccache
        mkdir -p ~/.ccache
        cat > ~/.ccache/ccache.conf << EOF
        max_size = 2.0G
        cache_dir = /workdir/.ccache
        compression = true
        compression_level = 1
        sloppiness = time_macros,include_file_mtime,include_file_ctime
        EOF
        
        # ä¼˜åŒ–ç³»ç»Ÿå‚æ•°
        echo "vm.swappiness=10" | sudo tee -a /etc/sysctl.conf
        echo "vm.vfs_cache_pressure=50" | sudo tee -a /etc/sysctl.conf
        sudo sysctl -p
        
        # è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
        export CCACHE_DIR="/workdir/.ccache"
        export CCACHE_MAXSIZE="2G"
        export FORCE_UNSAFE_CONFIGURE=1
        
        # æ˜¾ç¤ºä¼˜åŒ–åçŠ¶æ€
        echo "ä¼˜åŒ–åå†…å­˜:"
        free -h
        echo "ccacheçŠ¶æ€:"
        ccache -s

    - name: åˆ†é˜¶æ®µæ„å»ºå‡†å¤‡
      id: prepare
      if: matrix.stage == 'prepare'
      run: |
        cd openwrt
        
        echo "=== é˜¶æ®µ1: å‡†å¤‡ç¯å¢ƒ ==="
        # åº”ç”¨è‡ªå®šä¹‰é…ç½®
        [ -e $GITHUB_WORKSPACE/$FEEDS_CONF ] && cp $GITHUB_WORKSPACE/$FEEDS_CONF feeds.conf.default
        [ -e $GITHUB_WORKSPACE/files ] && cp -r $GITHUB_WORKSPACE/files .
        
        # æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬
        [ -x $GITHUB_WORKSPACE/$DIY_P1_SH ] && $GITHUB_WORKSPACE/$DIY_P1_SH
        
        echo "æ›´æ–°feeds..."
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        [ -e $GITHUB_WORKSPACE/$CONFIG_FILE ] && cp $GITHUB_WORKSPACE/$CONFIG_FILE .config
        [ -x $GITHUB_WORKSPACE/$DIY_P2_SH ] && $GITHUB_WORKSPACE/$DIY_P2_SH
        
        echo "ä¸‹è½½é¢„ç¼–è¯‘åŒ…..."
        make defconfig
        make download -j$(nproc) || make download -j2
        
        # æ¸…ç†æ— æ•ˆçš„ä¸‹è½½æ–‡ä»¶
        find dl -size -1024c -delete 2>/dev/null || true
        
        echo "å‡†å¤‡é˜¶æ®µå®Œæˆ"

    - name: åˆ†é˜¶æ®µç¼–è¯‘
      id: compile  
      if: matrix.stage == 'compile'
      run: |
        cd openwrt
        
        echo "=== é˜¶æ®µ2: ç¼–è¯‘å›ºä»¶ ==="
        echo "ç³»ç»Ÿèµ„æºçŠ¶æ€:"
        free -h
        df -h
        
        # å†…å­˜ä¼˜åŒ–ç¼–è¯‘
        MEM_AVAILABLE=$(free -g | awk 'NR==2{print $7}')
        if [ $MEM_AVAILABLE -lt 4 ]; then
          JOBS=1
          echo "å†…å­˜ç´§å¼ ï¼Œä½¿ç”¨å•çº¿ç¨‹ç¼–è¯‘"
        elif [ $MEM_AVAILABLE -lt 8 ]; then
          JOBS=2
          echo "å†…å­˜ä¸­ç­‰ï¼Œä½¿ç”¨2çº¿ç¨‹ç¼–è¯‘"
        else
          JOBS=$(($(nproc) - 1))
          echo "å†…å­˜å……è¶³ï¼Œä½¿ç”¨$JOBSçº¿ç¨‹ç¼–è¯‘"
        fi
        
        # åˆ†æ­¥éª¤ç¼–è¯‘ï¼Œå‡å°‘å†…å­˜å³°å€¼
        echo "å¼€å§‹ç¼–è¯‘..."
        for step in toolchain/install target/compile package/compile package/index; do
          echo "ç¼–è¯‘æ­¥éª¤: $step"
          make $step -j$JOBS || make $step -j1 V=s
        done
        
        # æœ€ç»ˆé“¾æ¥
        echo "æœ€ç»ˆé“¾æ¥..."
        make -j1 || make -j1 V=s
        
        echo "status=success" >> $GITHUB_OUTPUT
        grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' > DEVICE_NAME
        [ -s DEVICE_NAME ] && echo "DEVICE_NAME=_$(cat DEVICE_NAME)" >> $GITHUB_ENV
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    - name: èµ„æºç›‘æ§
      uses: ./.github/actions/monitor-resources
      if: always()
      with:
        interval: 30

    - name: æ•´ç†è¾“å‡ºæ–‡ä»¶
      if: steps.compile.outputs.status == 'success' && !cancelled()
      run: |
        cd openwrt/bin/targets/*/*
        echo "=== æ•´ç†è¾“å‡ºæ–‡ä»¶ ==="
        
        # åˆ é™¤ä¸å¿…è¦çš„æ–‡ä»¶
        rm -rf packages
        find . -name "*.buildinfo" -delete
        find . -name "*.json" -delete
        
        # é‡å‘½åæ–‡ä»¶ä»¥ä¾¿è¯†åˆ«
        for file in *; do
          if [[ $file == *"rootfs"* ]] || [[ $file == *"kernel"* ]] || [[ $file == *"sysupgrade"* ]]; then
            newname="${file//rootfs/rootfs${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}}"
            mv "$file" "$newname" 2>/dev/null || true
          fi
        done
        
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "æ–‡ä»¶åˆ—è¡¨:"
        ls -la

    - name: ä¸Šä¼ å›ºä»¶
      uses: actions/upload-artifact@v4
      if: steps.compile.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_${{ env.DEVICE_NAME }}_${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}/*
        compression-level: 0
        retention-days: 7

    - name: å‘å¸ƒåˆ°Release
      uses: softprops/action-gh-release@v2
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        files: ${{ env.FIRMWARE }}/*
        tag_name: build_${{ env.FILE_DATE }}
        name: ç¼–è¯‘å®Œæˆ ${{ env.FILE_DATE }}
        body: |
          ğŸš€ OpenWrt å›ºä»¶ç¼–è¯‘å®Œæˆ
          - è®¾å¤‡: ${{ env.DEVICE_NAME }}
          - æ—¶é—´: ${{ env.FILE_DATE }}
          - æºç : ${{ env.REPO_URL }}@${{ env.REPO_BRANCH }}
        draft: false
        prerelease: false

    - name: æ¸…ç†å·¥ä½œç©ºé—´
      if: always()
      run: |
        echo "=== æœ€ç»ˆæ¸…ç† ==="
        sudo rm -rf /workdir/openwrt/build_dir
        sudo rm -rf /workdir/openwrt/staging_dir
        sudo rm -rf /workdir/openwrt/tmp
        df -h
