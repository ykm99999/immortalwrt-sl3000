name: Build Siluo SL-3000 ImmortalWrt 24.10

on:
  workflow_dispatch:   # 仅手动触发，不会自动运行

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    steps:
    # 先 checkout 你自己的仓库，保证 sl3000.config 存在
    - name: Checkout my repo
      uses: actions/checkout@v4

    - name: Aggressive disk cleanup
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/lib/jvm \
                     /usr/lib/google-cloud-sdk /usr/local/share/boost
        sudo apt-get clean
        sudo docker system prune -af || true
        df -h

    - name: Checkout source
      run: |
        git clone https://github.com/immortalwrt/immortalwrt.git openwrt
        cd openwrt
        git checkout openwrt-24.10

    - name: Install minimal dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential g++ gawk git libncurses5-dev libssl-dev \
          python3 unzip zlib1g-dev file wget ccache
        sudo apt-get clean
        df -h

    - name: Add custom DTS & mk
      run: |
        mkdir -p openwrt/target/linux/mediatek/{dts,image}
        curl -L https://raw.githubusercontent.com/ykm99999/immortalwrt-sl3000/refs/heads/main/target/linux/mediatek/dts/mt7981-siluo-sl3000.dts \
          -o openwrt/target/linux/mediatek/dts/mt7981-siluo-sl3000.dts
        curl -L https://raw.githubusercontent.com/ykm99999/immortalwrt-sl3000/refs/heads/main/target/linux/mediatek/image/mt7981.mk \
          -o openwrt/target/linux/mediatek/image/mt7981.mk

    - name: Configure target
      run: |
        cd openwrt
        cp ../sl3000.config .config
        make defconfig

    - name: Build firmware
      run: |
        cd openwrt
        make -j$(nproc) V=s IGNORE_ERRORS=m

    - name: Cleanup after build
      run: |
        cd openwrt
        rm -rf tmp build_dir staging_dir logs packages
        df -h

    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: sl3000-firmware
        path: openwrt/bin/targets/mediatek/mt7981/*.bin
