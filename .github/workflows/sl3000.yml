name: SL3000 固件编译

on:
  workflow_dispatch:

permissions:
  contents: write

env:
  REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x-24.10
  REPO_BRANCH: 2410
  CONFIG_FILE: sl3000.config
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: 检出仓库
        uses: actions/checkout@v4

      - name: 初始化环境
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y build-essential git wget curl unzip rsync file \
            python3 python3-pip python3-setuptools python3-venv \
            libncurses5-dev libncursesw5-dev swig libseccomp-dev gawk flex gettext \
            libssl-dev zlib1g-dev ninja-build pkg-config meson cmake

      - name: 克隆源码
        run: git clone --depth=1 "$REPO_URL" -b "$REPO_BRANCH" openwrt

      - name: 写入 feeds.conf.default
        run: |
          cat > openwrt/feeds.conf.default << 'EOF'
          src-git packages https://github.com/immortalwrt/packages.git;master
          src-git luci https://github.com/immortalwrt/luci.git;master
          src-git routing https://github.com/openwrt-routing/packages.git;openwrt-23.05
          src-git telephony https://github.com/openwrt/telephony.git;openwrt-23.05
          src-git passwall2 https://github.com/xiaorouji/openwrt-passwall2.git;main
          EOF

      - name: 更新并安装 feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: 修补 json-c
        run: |
          JSONC_DIR="openwrt/package/libs/libjson-c"
          PATCH_DIR="$JSONC_DIR/patches"
          mkdir -p "$PATCH_DIR"
          cat > "$PATCH_DIR/010-fix-cmake-minimum.patch" <<'EOF'
--- a/apps/CMakeLists.txt
+++ b/apps/CMakeLists.txt
@@ -1,7 +1,7 @@
-cmake_minimum_required(VERSION 2.8)
+cmake_minimum_required(VERSION 3.5)
 project(json-c-apps C)
EOF

      - name: 准备 .config
        run: |
          cp "$CONFIG_FILE" openwrt/.config
          cd openwrt
          make defconfig

      - name: 编译固件
        run: |
          cd openwrt
          make -j"$(nproc)" || make -j1 V=s

      - name: 收集固件
        run: |
          cd openwrt/bin/targets/*/*
          rm -rf packages
          echo "FIRMWARE=$PWD" >> "$GITHUB_ENV"

      - name: 上传固件
        uses: actions/upload-artifact@v4
        with:
          name: SL3000_firmware
          path: ${{ env.FIRMWARE }}

      - name: 发布固件
        uses: softprops/action-gh-release@v2.1.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: ${{ env.FIRMWARE }}/*
          name: SL3000 固件
          tag_name: ${{ github.run_id }}
