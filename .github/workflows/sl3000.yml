name: SL3000 Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential
        sudo apt-get install -y libssl-dev libncurses5-dev
        sudo apt-get install -y gawk gettext unzip python3
        sudo apt-get install -y subversion git wget curl
        sudo apt-get clean

    - name: Clone Source
      run: |
        git clone --depth=1 https://github.com/padavanonly/immortalwrt-mt798x openwrt

    - name: Remove Problematic Feeds
      run: |
        cd openwrt
        # 完全移除 modemfeed
        sed -i '/modemfeed/d' feeds.conf.default
        # 或者注释掉所有不必要的 feeds
        sed -i 's|src-git modemfeed|# src-git modemfeed|' feeds.conf.default
        sed -i 's|src-git kiddin9|# src-git kiddin9|' feeds.conf.default

    - name: Setup Feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Apply Configuration
      run: |
        cd openwrt
        cp ../.config .config
        make defconfig

    - name: Download
      run: |
        cd openwrt
        make download -j2

    - name: Compile
      run: |
        cd openwrt
        make -j2

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: firmware
        path: openwrt/bin/targets/**/*
