name: å¸æ´›SL-3000 EMMC - ä¿®å¤ä¼˜åŒ–ç‰ˆ

on:
  repository_dispatch:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x-24.10
  REPO_BRANCH: 2410
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: sl3000.config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 240

    steps:
    - name: æ£€æŸ¥å·¥ä½œç©ºé—´
      run: |
        echo "åˆå§‹ç£ç›˜ç©ºé—´:"
        df -h
        echo "å†…å­˜ä¿¡æ¯:"
        free -h
        echo "GITHUB_WORKSPACE=$GITHUB_WORKSPACE"
        ls -la $GITHUB_WORKSPACE || true

    - name: Checkout
      uses: actions/checkout@v4

    - name: å®‰å…¨æ·±åº¦æ¸…ç†
      run: |
        echo "=== å®‰å…¨æ·±åº¦æ¸…ç† ==="
        sudo systemctl stop docker containerd snapd 2>/dev/null || echo "æœåŠ¡åœæ­¢è·³è¿‡"
        sudo apt-get autoremove --purge -y || true
        sudo apt-get clean || true

        cache_dirs=(
          "/usr/share/dotnet"
          "/opt/ghc"
          "/usr/local/lib/android"
          "/opt/hostedtoolcache/CodeQL"
          "/usr/local/lib/node_modules"
          "/var/lib/docker"
          "/var/lib/snapd"
        )

        for dir in "${cache_dirs[@]}"; do
          if [ -d "$dir" ]; then
            echo "æ¸…ç†ç›®å½•: $dir"
            sudo rm -rf "$dir" 2>/dev/null || true
          fi
        done

        sudo find /var/log -name "*.log" -type f -exec truncate -s 0 {} \; 2>/dev/null || true

        echo "æ¸…ç†åç©ºé—´:"
        df -h
        free -h

    - name: é…ç½®æ™ºèƒ½ç¼“å­˜
      uses: actions/cache@v3
      with:
        path: |
          ~/.ccache
          ${{ github.workspace }}/openwrt/dl
          ${{ github.workspace }}/openwrt/build_dir
        key: ${{ runner.os }}-openwrt-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-openwrt-

    - name: å…‹éš†æºç 
      run: |
        cd $GITHUB_WORKSPACE
        if [ -d "openwrt" ]; then
          echo "ä½¿ç”¨ç°æœ‰ä»“åº“"
          cd openwrt
          git fetch --depth=1 origin $REPO_BRANCH || true
          git reset --hard origin/$REPO_BRANCH || true
        else
          echo "å…‹éš†æ–°ä»“åº“"
          git clone --depth=1 --branch $REPO_BRANCH $REPO_URL openwrt
          cd openwrt
        fi

        # ä¿æŒä¸€ä¸ªå·¥ä½œåŒºç¬¦å·é“¾æ¥ï¼ˆæ–¹ä¾¿æ—§è„šæœ¬ï¼‰
        ln -sf $GITHUB_WORKSPACE/openwrt $GITHUB_WORKSPACE/openwrt

    - name: å®‰è£…å¿…è¦ä¾èµ–
      run: |
        echo "å®‰è£…ç¼–è¯‘ä¾èµ–..."
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          ccache \
          cmake \
          git \
          make \
          libssl-dev \
          libncurses5-dev \
          zlib1g-dev \
          gawk \
          gettext \
          flex \
          bison \
          python3 \
          rsync \
          unzip \
          wget

    - name: å‡†å¤‡ç¼–è¯‘ç¯å¢ƒ
      run: |
        cd $GITHUB_WORKSPACE/openwrt

        [ -e $GITHUB_WORKSPACE/$FEEDS_CONF ] && cp $GITHUB_WORKSPACE/$FEEDS_CONF feeds.conf.default
        [ -e $GITHUB_WORKSPACE/files ] && cp -r $GITHUB_WORKSPACE/files .

        [ -x $GITHUB_WORKSPACE/$DIY_P1_SH ] && $GITHUB_WORKSPACE/$DIY_P1_SH

        echo "æ›´æ–°å’Œå®‰è£…feeds..."
        ./scripts/feeds update -a
        ./scripts/feeds install -a

        [ -e $GITHUB_WORKSPACE/$CONFIG_FILE ] && cp $GITHUB_WORKSPACE/$CONFIG_FILE .config
        [ -x $GITHUB_WORKSPACE/$DIY_P2_SH ] && $GITHUB_WORKSPACE/$DIY_P2_SH

    - name: èµ„æºç›‘æ§è„šæœ¬
      run: |
        cat > /tmp/monitor_resources.sh << 'EOF'
        #!/bin/bash
        echo "=== èµ„æºç›‘æ§å¯åŠ¨ ==="
        while true; do
          echo "$(date): å†…å­˜ä½¿ç”¨: $(free -h | awk 'NR==2{print $3"/"$2}'), ç£ç›˜ä½¿ç”¨: $(df -h $GITHUB_WORKSPACE | awk 'NR==2{print $3"/"$2" ("$5")"}')"
          sleep 60
        done
        EOF

        sed -i "s|$GITHUB_WORKSPACE|${GITHUB_WORKSPACE}|g" /tmp/monitor_resources.sh || true
        chmod +x /tmp/monitor_resources.sh
        /tmp/monitor_resources.sh &

    - name: ä¸‹è½½è½¯ä»¶åŒ…
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        echo "ç”Ÿæˆé…ç½®..."
        make defconfig

        echo "ä¸‹è½½è½¯ä»¶åŒ…..."
        make download -j$(nproc) || make download -j2

        find dl -size -1024c -delete 2>/dev/null || true

    - name: ç¼–è¯‘å›ºä»¶
      id: compile
      run: |
        cd $GITHUB_WORKSPACE/openwrt

        echo "=== å¼€å§‹ç¼–è¯‘å›ºä»¶ ==="
        echo "å½“å‰èµ„æºçŠ¶æ€:"
        free -h
        df -h

        MEM_AVAILABLE=$(free -g | awk 'NR==2{print $7}')
        if [ "$MEM_AVAILABLE" -lt 4 ]; then
          JOBS=1
          echo "å†…å­˜ç´§å¼ ï¼Œä½¿ç”¨å•çº¿ç¨‹ç¼–è¯‘"
        elif [ "$MEM_AVAILABLE" -lt 8 ]; then
          JOBS=2
          echo "å†…å­˜ä¸­ç­‰ï¼Œä½¿ç”¨2çº¿ç¨‹ç¼–è¯‘"
        else
          JOBS=$(($(nproc) - 1))
          echo "å†…å­˜å……è¶³ï¼Œä½¿ç”¨ $JOBS çº¿ç¨‹ç¼–è¯‘"
        fi

        echo "ä½¿ç”¨ $JOBS çº¿ç¨‹ç¼–è¯‘..."
        make -j$JOBS || make -j1 V=s

        echo "status=success" >> $GITHUB_OUTPUT
        grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' > DEVICE_NAME
        [ -s DEVICE_NAME ] && echo "DEVICE_NAME=_$(cat DEVICE_NAME)" >> $GITHUB_ENV
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    - name: æ•´ç†è¾“å‡ºæ–‡ä»¶
      if: steps.compile.outputs.status == 'success' && !cancelled()
      run: |
        cd $GITHUB_WORKSPACE/openwrt/bin/targets/*/*
        echo "=== æ•´ç†å›ºä»¶æ–‡ä»¶ ==="
        rm -rf packages 2>/dev/null || true
        echo "å›ºä»¶æ–‡ä»¶åˆ—è¡¨:"
        ls -la
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV

    - name: ä¸Šä¼ å›ºä»¶åˆ¶å“
      uses: actions/upload-artifact@v4
      if: steps.compile.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_å›ºä»¶_${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}/*
        retention-days: 7

    - name: å‘å¸ƒåˆ°GitHub Release
      if: env.UPLOAD_RELEASE == 'true' && steps.compile.outputs.status == 'success' && !cancelled()
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        files: ${{ env.FIRMWARE }}/*
        tag_name: build_${{ env.FILE_DATE }}
        name: ç¼–è¯‘å®Œæˆ ${{ env.FILE_DATE }}
        body: |
          ğŸš€ OpenWrt å›ºä»¶ç¼–è¯‘å®Œæˆ
          - æ—¶é—´: ${{ env.FILE_DATE }}
          - æºç : ${{ env.REPO_URL }}
          - åˆ†æ”¯: ${{ env.REPO_BRANCH }}
        draft: false
        prerelease: false

    - name: æ¸…ç†å·¥ä½œç©ºé—´
      if: always()
      run: |
        echo "=== æœ€ç»ˆæ¸…ç† ==="
        pkill -f monitor_resources.sh 2>/dev/null || true
        echo "ç¼–è¯‘å®Œæˆ"
