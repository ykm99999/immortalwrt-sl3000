name: å¸æ´›SL-3000 EMMC - ä¾èµ–ä¿®å¤ç‰ˆ

on:
  repository_dispatch:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x-24.10
  REPO_BRANCH: 2410
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: sl3000.config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 240

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: ç³»ç»Ÿæ¸…ç†
      run: |
        sudo apt-get autoremove -y
        sudo apt-get clean
        sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/lib/android

    - name: é…ç½®ç¼“å­˜
      uses: actions/cache@v3
      with:
        path: |
          ~/.ccache
          /workdir/openwrt/dl
        key: ${{ runner.os }}-openwrt-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-openwrt-

    - name: å…‹éš†æºç 
      working-directory: /workdir
      run: |
        if [ -d "openwrt" ]; then
          cd openwrt
          git fetch --depth=1
          git reset --hard origin/$REPO_BRANCH
        else
          git clone --depth=1 --branch $REPO_BRANCH $REPO_URL openwrt
          cd openwrt
        fi
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

    - name: å®‰è£…ä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential ccache cmake git make \
          libssl-dev libncurses5-dev zlib1g-dev \
          gawk gettext flex bison python3 \
          rsync unzip wget

    - name: ä¿®å¤ä¾èµ–é…ç½®
      run: |
        cd openwrt
        
        # å¤‡ä»½åŸå§‹feedsé…ç½®
        [ -e $GITHUB_WORKSPACE/$FEEDS_CONF ] && cp $GITHUB_WORKSPACE/$FEEDS_CONF feeds.conf.default
        
        # æ£€æŸ¥å¹¶ä¿®å¤feedsé…ç½®
        if ! grep -q "src-git packages" feeds.conf.default; then
          cat >> feeds.conf.default << 'EOF'
        src-git packages https://git.openwrt.org/feed/packages.git;openwrt-24.10
        src-git luci https://git.openwrt.org/project/luci.git;openwrt-24.10
        src-git routing https://git.openwrt.org/feed/routing.git;openwrt-24.10
        src-git telephony https://git.openwrt.org/feed/telephony.git;openwrt-24.10
        EOF
        fi

        # æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬
        [ -x $GITHUB_WORKSPACE/$DIY_P1_SH ] && $GITHUB_WORKSPACE/$DIY_P1_SH

    - name: æ›´æ–°å’Œå®‰è£…Feedsï¼ˆä¿®å¤ç‰ˆï¼‰
      run: |
        cd openwrt
        
        echo "=== æ›´æ–°Feeds ==="
        ./scripts/feeds update -a
        
        echo "=== å®‰è£…åŸºç¡€åŒ… ==="
        # å…ˆå®‰è£…åŸºç¡€åŒ…ï¼Œé¿å…ä¾èµ–é—®é¢˜
        ./scripts/feeds install -a -p packages
        ./scripts/feeds install -a -p luci
        ./scripts/feeds install -a -p routing
        
        echo "=== å®‰è£…telephonyåŒ…ï¼ˆè·³è¿‡æœ‰é—®é¢˜çš„åŒ…ï¼‰==="
        # å•ç‹¬å®‰è£…telephonyåŒ…ï¼Œè·³è¿‡æœ‰é—®é¢˜çš„åŒ…
        for pkg in $(./scripts/feeds list -r telephony | cut -d' ' -f2); do
          case "$pkg" in
            libpcre|*freeswitch*|*kamailio*)
              echo "è·³è¿‡æœ‰é—®é¢˜çš„åŒ…: $pkg"
              ;;
            *)
              echo "å®‰è£…åŒ…: $pkg"
              ./scripts/feeds install -p telephony $pkg || true
              ;;
          esac
        done
        
        echo "=== å®‰è£…å…¶ä»–åŒ… ==="
        ./scripts/feeds install -a

    - name: åº”ç”¨é…ç½®
      run: |
        cd openwrt
        [ -e $GITHUB_WORKSPACE/$CONFIG_FILE ] && cp $GITHUB_WORKSPACE/$CONFIG_FILE .config
        [ -x $GITHUB_WORKSPACE/$DIY_P2_SH ] && $GITHUB_WORKSPACE/$DIY_P2_SH

    - name: ä¸‹è½½è½¯ä»¶åŒ…
      run: |
        cd openwrt
        make defconfig
        echo "å¼€å§‹ä¸‹è½½è½¯ä»¶åŒ…..."
        make download -j$(nproc) || make download -j1
        # æ¸…ç†æ— æ•ˆä¸‹è½½
        find dl -size -1024c -delete 2>/dev/null || true

    - name: ç¼–è¯‘å›ºä»¶ï¼ˆå®‰å…¨æ¨¡å¼ï¼‰
      id: compile
      run: |
        cd openwrt
        
        echo "=== å¼€å§‹ç¼–è¯‘ ==="
        echo "èµ„æºçŠ¶æ€:"
        free -h
        df -h
        
        # å®‰å…¨ç¼–è¯‘æ¨¡å¼
        echo "ä½¿ç”¨å®‰å…¨ç¼–è¯‘æ¨¡å¼ï¼ˆå•çº¿ç¨‹ï¼‰..."
        make -j1 V=s || make -j1 V=sc
        
        echo "status=success" >> $GITHUB_OUTPUT
        grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' > DEVICE_NAME
        [ -s DEVICE_NAME ] && echo "DEVICE_NAME=_$(cat DEVICE_NAME)" >> $GITHUB_ENV
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    - name: æ•´ç†è¾“å‡º
      if: steps.compile.outputs.status == 'success' && !cancelled()
      run: |
        cd openwrt/bin/targets/*/*
        rm -rf packages
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV

    - name: ä¸Šä¼ å›ºä»¶
      uses: actions/upload-artifact@v4
      if: steps.compile.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_å›ºä»¶_${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}/*
        retention-days: 7

    - name: å‘å¸ƒRelease
      if: env.UPLOAD_RELEASE == 'true' && steps.compile.outputs.status == 'success' && !cancelled()
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        files: ${{ env.FIRMWARE }}/*
        tag_name: build_${{ env.FILE_DATE }}
        name: ç¼–è¯‘å®Œæˆ ${{ env.FILE_DATE }}
        body: |
          ğŸš€ OpenWrt å›ºä»¶ç¼–è¯‘å®Œæˆ
          - æ—¶é—´: ${{ env.FILE_DATE }}
          - æºç : ${{ env.REPO_URL }}
        draft: false
        prerelease: false
