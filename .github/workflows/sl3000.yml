name: å¸æ´›SL-3000 EMMC ç¼–è¯‘

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x-24.10
  REPO_BRANCH: 2410
  CONFIG_FILE: sl3000.config
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180

    steps:
    - name: æ£€æŸ¥å·¥ä½œç©ºé—´
      run: |
        echo "å·¥ä½œç›®å½•: $GITHUB_WORKSPACE"
        echo "ç›®å½•å†…å®¹:"
        ls -la
        echo "ç£ç›˜ç©ºé—´:"
        df -h
        echo "å†…å­˜ä¿¡æ¯:"
        free -h

    - name: Checkout ä»£ç 
      uses: actions/checkout@v4

    - name: ç³»ç»Ÿæ¸…ç†
      run: |
        sudo apt-get autoremove -y
        sudo apt-get clean
        # æ¸…ç†ä¸€äº›ç¼“å­˜ç›®å½•é‡Šæ”¾ç©ºé—´
        sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/lib/android 2>/dev/null || true

    - name: é…ç½®ç¼–è¯‘ç¼“å­˜
      uses: actions/cache@v3
      with:
        path: |
          ~/.ccache
          ./openwrt/dl
        key: ${{ runner.os }}-openwrt-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-openwrt-

    - name: å…‹éš† OpenWrt æºç 
      run: |
        echo "å¼€å§‹å…‹éš† OpenWrt æºç ..."
        if [ -d "openwrt" ] && [ -d "openwrt/.git" ]; then
          echo "ä½¿ç”¨ç°æœ‰ä»“åº“"
          cd openwrt
          git fetch --depth=1
          git reset --hard origin/$REPO_BRANCH
        else
          echo "å…‹éš†æ–°ä»“åº“"
          rm -rf openwrt
          git clone --depth=1 --branch $REPO_BRANCH $REPO_URL openwrt
        fi
        
        echo "æºç ç›®å½•å¤§å°:"
        du -sh openwrt

    - name: å®‰è£…ç¼–è¯‘ä¾èµ–
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          ccache \
          cmake \
          git \
          make \
          libssl-dev \
          libncurses5-dev \
          zlib1g-dev \
          gawk \
          gettext \
          flex \
          bison \
          python3 \
          python3-pip \
          rsync \
          unzip \
          wget \
          curl

    - name: å‡†å¤‡ç¼–è¯‘é…ç½®
      run: |
        cd openwrt
        
        echo "=== å‡†å¤‡ç¼–è¯‘é…ç½® ==="
        
        # æ£€æŸ¥å¹¶åº”ç”¨è‡ªå®šä¹‰é…ç½®
        if [ -f "../$CONFIG_FILE" ]; then
          echo "æ‰¾åˆ°é…ç½®æ–‡ä»¶: ../$CONFIG_FILE"
          cp "../$CONFIG_FILE" .config
        else
          echo "è­¦å‘Š: æœªæ‰¾åˆ°é…ç½®æ–‡ä»¶ $CONFIG_FILE"
        fi
        
        # æ£€æŸ¥æ˜¯å¦æœ‰è‡ªå®šä¹‰æ–‡ä»¶
        if [ -d "../files" ]; then
          echo "åº”ç”¨è‡ªå®šä¹‰æ–‡ä»¶"
          cp -r "../files" .
        fi
        
        # æ£€æŸ¥å¹¶æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬
        if [ -f "../diy-part1.sh" ] && [ -x "../diy-part1.sh" ]; then
          echo "æ‰§è¡Œ diy-part1.sh"
          ../diy-part1.sh
        fi

    - name: æ›´æ–°å’Œå®‰è£…è½¯ä»¶æº
      run: |
        cd openwrt
        
        echo "=== æ›´æ–°è½¯ä»¶æº ==="
        ./scripts/feeds update -a
        
        echo "=== å®‰è£…è½¯ä»¶åŒ… ==="
        # åˆ†æ­¥éª¤å®‰è£…ï¼Œé¿å…ä¾èµ–é—®é¢˜
        ./scripts/feeds install -a -p packages
        ./scripts/feeds install -a -p luci
        ./scripts/feeds install -a -p routing
        
        # é€‰æ‹©æ€§å®‰è£…telephonyåŒ…ï¼Œè·³è¿‡æœ‰é—®é¢˜çš„
        ./scripts/feeds install -p telephony rem || true
        ./scripts/feeds install -p telephony coturn || true
        ./scripts/feeds install -p telephony libosip2 || true
        
        # å®‰è£…å…¶ä»–åŒ…
        ./scripts/feeds install -a

    - name: åº”ç”¨æœ€ç»ˆé…ç½®
      run: |
        cd openwrt
        
        # æ‰§è¡Œç¬¬äºŒé˜¶æ®µè‡ªå®šä¹‰è„šæœ¬
        if [ -f "../diy-part2.sh" ] && [ -x "../diy-part2.sh" ]; then
          echo "æ‰§è¡Œ diy-part2.sh"
          ../diy-part2.sh
        fi
        
        echo "ç”Ÿæˆæœ€ç»ˆé…ç½®"
        make defconfig
        
        echo "æ˜¾ç¤ºç›®æ ‡è®¾å¤‡é…ç½®:"
        grep "CONFIG_TARGET" .config | grep "=y" || true

    - name: ä¸‹è½½è½¯ä»¶åŒ…
      run: |
        cd openwrt
        echo "å¼€å§‹ä¸‹è½½è½¯ä»¶åŒ…..."
        make download -j2 || make download -j1
        
        # æ£€æŸ¥ä¸‹è½½ç»“æœ
        echo "ä¸‹è½½çš„è½¯ä»¶åŒ…:"
        ls -la dl/ | head -10
        echo "dlç›®å½•å¤§å°:"
        du -sh dl/

    - name: ç¼–è¯‘å›ºä»¶
      id: compile
      run: |
        cd openwrt
        
        echo "=== å¼€å§‹ç¼–è¯‘å›ºä»¶ ==="
        echo "ç¼–è¯‘å‰èµ„æºçŠ¶æ€:"
        free -h
        df -h
        
        # æ ¹æ®å¯ç”¨å†…å­˜è®¾ç½®ç¼–è¯‘çº¿ç¨‹
        AVAILABLE_MEM=$(free -g | awk 'NR==2{print $7}')
        echo "å¯ç”¨å†…å­˜: ${AVAILABLE_MEM}G"
        
        if [ "$AVAILABLE_MEM" -lt 2 ]; then
          JOBS=1
          echo "å†…å­˜è¾ƒå°‘ï¼Œä½¿ç”¨å•çº¿ç¨‹ç¼–è¯‘"
        elif [ "$AVAILABLE_MEM" -lt 4 ]; then
          JOBS=2
          echo "å†…å­˜ä¸­ç­‰ï¼Œä½¿ç”¨2çº¿ç¨‹ç¼–è¯‘"
        else
          JOBS=$(($(nproc) > 4 ? 4 : $(nproc)))
          echo "å†…å­˜å……è¶³ï¼Œä½¿ç”¨ $JOBS çº¿ç¨‹ç¼–è¯‘"
        fi
        
        echo "å¼€å§‹ç¼–è¯‘ï¼Œä½¿ç”¨ $JOBS çº¿ç¨‹..."
        make -j$JOBS
        
        echo "status=success" >> $GITHUB_OUTPUT
        
        # è·å–è®¾å¤‡åç§°
        if grep -q '^CONFIG_TARGET.*DEVICE.*=y' .config; then
          DEVICE_NAME=$(grep '^CONFIG_TARGET.*DEVICE.*=y' .config | head -1 | sed -r 's/.*DEVICE_(.*)=y/\1/')
          echo "DEVICE_NAME=_${DEVICE_NAME}" >> $GITHUB_ENV
        else
          echo "DEVICE_NAME=sl3000" >> $GITHUB_ENV
        fi
        
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    - name: æ•´ç†å›ºä»¶æ–‡ä»¶
      if: steps.compile.outputs.status == 'success' && !cancelled()
      run: |
        cd openwrt/bin/targets/*/*
        echo "=== å›ºä»¶æ–‡ä»¶ ==="
        ls -la
        
        # åˆ é™¤ä¸å¿…è¦çš„æ–‡ä»¶
        rm -rf packages 2>/dev/null || true
        
        echo "å›ºä»¶æ–‡ä»¶åˆ—è¡¨:"
        find . -type f -name "*.bin" -o -name "*.img" -o -name "*.gz" | sort
        
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV

    - name: ä¸Šä¼ å›ºä»¶åˆ¶å“
      if: steps.compile.outputs.status == 'success' && !cancelled()
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrtå›ºä»¶_${{ env.DEVICE_NAME }}_${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}/*
        retention-days: 30

    - name: å‘å¸ƒåˆ° GitHub Release
      if: env.UPLOAD_RELEASE == 'true' && steps.compile.outputs.status == 'success' && !cancelled()
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        files: ${{ env.FIRMWARE }}/*
        tag_name: build-${{ env.FILE_DATE }}
        name: SL-3000 å›ºä»¶ ${{ env.FILE_DATE }}
        body: |
          # å¸æ´› SL-3000 OpenWrt å›ºä»¶
          
          ğŸš€ **è‡ªåŠ¨ç¼–è¯‘å®Œæˆ**
          
          - **ç¼–è¯‘æ—¶é—´**: ${{ env.FILE_DATE }}
          - **è®¾å¤‡å‹å·**: å¸æ´› SL-3000
          - **æºç ç‰ˆæœ¬**: ${{ env.REPO_BRANCH }}
          - **æºç ä»“åº“**: ${{ env.REPO_URL }}
          
          ## ä½¿ç”¨è¯´æ˜
          
          1. é€‰æ‹©å¯¹åº”çš„å›ºä»¶æ–‡ä»¶åˆ·å…¥
          2. é¦–æ¬¡ä½¿ç”¨å»ºè®®æ¢å¤å‡ºå‚è®¾ç½®
          3. å¦‚æœ‰é—®é¢˜è¯·æäº¤ Issue
          
          ## æ–‡ä»¶åˆ—è¡¨
          
          è¯¦è§ Artifacts æˆ– Release æ–‡ä»¶åˆ—è¡¨
        draft: false
        prerelease: false

    - name: ç¼–è¯‘å®Œæˆé€šçŸ¥
      if: always()
      run: |
        if [ "${{ steps.compile.outputs.status }}" = "success" ]; then
          echo "ğŸ‰ å›ºä»¶ç¼–è¯‘æˆåŠŸ!"
          echo "ğŸ“ å›ºä»¶ä½ç½®: ${{ env.FIRMWARE }}"
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥"
          exit 1
        fi
