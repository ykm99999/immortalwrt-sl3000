name: å¸æ´›SL-3000 ImmortalWrt æ™ºèƒ½æ–­ç‚¹ç»­ä¼ ç¼–è¯‘

on:
  workflow_dispatch:
    inputs:
      resume_from:
        description: 'ä»æŒ‡å®šé˜¶æ®µå¼€å§‹ç¼–è¯‘'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - start
          - after_fix
          - after_feeds
          - after_config
          - after_download
          - after_toolchain
          - after_kernel
          - after_packages
      clean_build:
        description: 'å®Œå…¨æ¸…ç†é‡æ–°ç¼–è¯‘'
        required: false
        default: false
        type: boolean
      skip_problematic:
        description: 'è·³è¿‡æœ‰é—®é¢˜çš„é©±åŠ¨'
        required: false
        default: true
        type: boolean

env:
  REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x
  REPO_BRANCH: main
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 240

    steps:
    # ==================== åˆå§‹åŒ–é˜¶æ®µ ====================
    - name: åˆå§‹åŒ–ç¯å¢ƒå’Œå‚æ•°
      id: init
      run: |
        echo "=== ç¼–è¯‘å‚æ•°åˆå§‹åŒ– ==="
        echo "å·¥ä½œç›®å½•: $GITHUB_WORKSPACE"
        echo "æ¢å¤æ¨¡å¼: ${{ github.event.inputs.resume_from }}"
        echo "æ¸…ç†æ„å»º: ${{ github.event.inputs.clean_build }}"
        echo "è·³è¿‡é—®é¢˜é©±åŠ¨: ${{ github.event.inputs.skip_problematic }}"
        echo "å½“å‰æ—¶é—´: $(date)"
        
        # è®¾ç½®é»˜è®¤æ¢å¤ç‚¹
        if [ "${{ github.event.inputs.resume_from }}" = "auto" ]; then
          echo "resume_point=start" >> $GITHUB_OUTPUT
        else
          echo "resume_point=${{ github.event.inputs.resume_from }}" >> $GITHUB_OUTPUT
        fi
        
        # æ¸…ç†é˜¶æ®µæ ‡è®°ï¼ˆå¦‚æœæ˜¯å®Œå…¨æ¸…ç†ï¼‰
        if [ "${{ github.event.inputs.clean_build }}" = "true" ]; then
          echo "æ¸…ç†æ‰€æœ‰é˜¶æ®µæ ‡è®°..."
          rm -f .stage_* 2>/dev/null || true
        fi

    - name: Checkout ä»£ç 
      uses: actions/checkout@v4

    # ==================== ç¼“å­˜é…ç½® ====================
    - name: é…ç½®æ™ºèƒ½åˆ†çº§ç¼“å­˜
      uses: actions/cache@v3
      id: cache
      with:
        path: |
          ~/.ccache
          ./openwrt/dl
          ./openwrt/staging_dir/host
          ./openwrt/staging_dir/toolchain-*
          ./openwrt/.config
          ./openwrt/tmp
          .stage_*
        key: ${{ runner.os }}-sl3000-resume-${{ github.sha }}-${{ steps.init.outputs.resume_point }}
        restore-keys: |
          ${{ runner.os }}-sl3000-resume-${{ github.sha }}-
          ${{ runner.os }}-sl3000-resume-

    # ==================== ä¾èµ–å®‰è£…é˜¶æ®µ ====================
    - name: å®‰è£…ç¼–è¯‘ä¾èµ–
      id: install_deps
      if: steps.init.outputs.resume_point == 'start' && !cancelled()
      run: |
        echo "=== é˜¶æ®µ1: å®‰è£…ç¼–è¯‘ä¾èµ– ==="
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          ccache \
          cmake \
          git \
          make \
          libssl-dev \
          libncurses5-dev \
          zlib1g-dev \
          gawk \
          gettext \
          flex \
          bison \
          python3 \
          python3-pip \
          rsync \
          unzip \
          wget \
          curl \
          file \
          gzip \
          bzip2 \
          xz-utils
        
        # åˆ›å»ºé˜¶æ®µå®Œæˆæ ‡è®°
        touch .stage_deps_complete
        echo "deps_ready=true" >> $GITHUB_OUTPUT

    # ==================== æºç å‡†å¤‡é˜¶æ®µ ====================
    - name: å…‹éš†å’Œä¿®å¤æºç 
      id: prepare_source
      if: |
        (steps.install_deps.outputs.deps_ready == 'true' || 
         steps.init.outputs.resume_point == 'after_fix') && 
        !cancelled()
      run: |
        echo "=== é˜¶æ®µ2: æºç å‡†å¤‡å’Œä¿®å¤ ==="
        
        # æ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°å…‹éš†
        if [ ! -d "openwrt" ] || [ "${{ github.event.inputs.clean_build }}" = "true" ]; then
          echo "å…‹éš†æºç ..."
          rm -rf openwrt
          git clone --depth=1 --branch $REPO_BRANCH $REPO_URL openwrt
        elif [ -d "openwrt" ] && [ -d "openwrt/.git" ]; then
          echo "æ›´æ–°ç°æœ‰æºç ..."
          cd openwrt
          git fetch --depth=1 origin $REPO_BRANCH
          git reset --hard origin/$REPO_BRANCH
          cd ..
        fi
        
        cd openwrt
        
        # ä¿®å¤å·²çŸ¥é—®é¢˜
        echo "ä¿®å¤å·²çŸ¥ç¼–è¯‘é—®é¢˜..."
        
        # 1. ä¿®å¤ WARP é©±åŠ¨å¸¸é‡é”™è¯¯
        if [ -f "package/mtk/drivers/warp/regs/reg_v1/warp_hw_v1.c" ] && [ "${{ github.event.inputs.skip_problematic }}" = "true" ]; then
          echo "ä¿®å¤ WARP é©±åŠ¨..."
          sed -i 's/WED_EX_INT_STA_FLD_TF_TKID_TITO_INVLD/WED_EX_INT_STA_FLD_TF_TKID_FIFO_INVLD/g' \
            "package/mtk/drivers/warp/regs/reg_v1/warp_hw_v1.c" 2>/dev/null || true
        fi
        
        # 2. é¢„ä¸‹è½½å…³é”®æ–‡ä»¶é¿å…ç½‘ç»œé—®é¢˜
        mkdir -p dl
        echo "é¢„ä¸‹è½½å…³é”®ä¾èµ–..."
        [ ! -f "dl/libdeflate-1.18.tar.gz" ] && \
          wget -q -O dl/libdeflate-1.18.tar.gz \
          "https://github.com/ebiggers/libdeflate/archive/refs/tags/v1.18.tar.gz" || true
        
        [ ! -f "dl/lua-5.1.5.tar.gz" ] && \
          wget -q -O dl/lua-5.1.5.tar.gz \
          "https://www.lua.org/ftp/lua-5.1.5.tar.gz" || true
        
        # 3. ç§»é™¤æœ‰é—®é¢˜çš„é©±åŠ¨ï¼ˆå¦‚æœé€‰æ‹©è·³è¿‡ï¼‰
        if [ "${{ github.event.inputs.skip_problematic }}" = "true" ]; then
          echo "è·³è¿‡æœ‰é—®é¢˜çš„é©±åŠ¨..."
          rm -rf package/mtk/drivers/conninfra 2>/dev/null || true
          rm -rf package/mtk/drivers/wifi-profile 2>/dev/null || true
        fi
        
        # åˆ›å»ºé˜¶æ®µå®Œæˆæ ‡è®°
        touch ../.stage_source_complete
        echo "source_ready=true" >> $GITHUB_OUTPUT

    # ==================== è½¯ä»¶æºé…ç½®é˜¶æ®µ ====================
    - name: é…ç½®è½¯ä»¶æº
      id: setup_feeds
      if: |
        (steps.prepare_source.outputs.source_ready == 'true' || 
         steps.init.outputs.resume_point == 'after_feeds') && 
        !cancelled()
      run: |
        echo "=== é˜¶æ®µ3: é…ç½®è½¯ä»¶æº ==="
        cd openwrt
        
        # é…ç½®ç¨³å®šçš„è½¯ä»¶æº
        cat > feeds.conf.default << 'EOF'
src-git packages https://git.openwrt.org/feed/packages.git
src-git luci https://git.openwrt.org/project/luci.git
src-git routing https://git.openwrt.org/feed/routing.git
# æ³¨é‡Šæ‰å¯èƒ½æœ‰é—®é¢˜çš„æº
# src-git telephony https://git.openwrt.org/feed/telephony.git
EOF

        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        # ç§»é™¤æœ‰é—®é¢˜çš„åŒ…
        if [ "${{ github.event.inputs.skip_problematic }}" = "true" ]; then
          ./scripts/feeds uninstall -a -p telephony 2>/dev/null || true
        fi
        
        touch ../.stage_feeds_complete
        echo "feeds_ready=true" >> $GITHUB_OUTPUT

    # ==================== é…ç½®åˆ›å»ºé˜¶æ®µ ====================
    - name: åˆ›å»ºç¼–è¯‘é…ç½®
      id: create_config
      if: |
        (steps.setup_feeds.outputs.feeds_ready == 'true' || 
         steps.init.outputs.resume_point == 'after_config') && 
        !cancelled()
      run: |
        echo "=== é˜¶æ®µ4: åˆ›å»ºç¼–è¯‘é…ç½® ==="
        cd openwrt
        
        # åªæœ‰é…ç½®ä¸å­˜åœ¨æˆ–éœ€è¦æ¸…ç†æ—¶æ‰é‡æ–°åˆ›å»º
        if [ ! -f ".config" ] || [ "${{ github.event.inputs.clean_build }}" = "true" ]; then
          echo "åˆ›å»ºæ–°çš„é…ç½®æ–‡ä»¶..."
          cat > .config << 'EOF'
CONFIG_TARGET_mediatek=y
CONFIG_TARGET_mediatek_mt7981=y
CONFIG_TARGET_mediatek_mt7981_DEVICE_cmcc_rax3000m-nand-ubootmod=y
CONFIG_TARGET_ROOTFS_PARTSIZE=256

# ç¼–è¯‘ä¼˜åŒ–
CONFIG_CCACHE=y

# åŸºç¡€ç³»ç»Ÿ
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-base=y
CONFIG_PACKAGE_luci-compat=y
CONFIG_PACKAGE_luci-theme-bootstrap=y
CONFIG_PACKAGE_luci-i18n-base-zh-cn=y

# ç½‘ç»œé…ç½®
CONFIG_PACKAGE_wpad-basic-wolfssl=y
CONFIG_PACKAGE_kmod-mt7981-firmware=y
CONFIG_PACKAGE_kmod-mt7915e=y

# ç³»ç»Ÿå·¥å…·
CONFIG_PACKAGE_block-mount=y
CONFIG_PACKAGE_fdisk=y

# ç¦ç”¨æœ‰é—®é¢˜çš„åŒ…
EOF

          # æ ¹æ®é€‰æ‹©æ·»åŠ ç¦ç”¨é…ç½®
          if [ "${{ github.event.inputs.skip_problematic }}" = "true" ]; then
            cat >> .config << 'EOF'
# CONFIG_PACKAGE_kmod-mtk-warp is not set
# CONFIG_PACKAGE_kmod-mtk-conninfra is not set
# CONFIG_PACKAGE_kmod-mtk-wifi-profile is not set
# CONFIG_PACKAGE_luci-app-passwall2 is not set
# CONFIG_PACKAGE_docker is not set
EOF
          fi
        else
          echo "ä½¿ç”¨ç°æœ‰çš„é…ç½®æ–‡ä»¶"
        fi
        
        # ç”Ÿæˆå®Œæ•´é…ç½®
        make defconfig
        
        echo "é…ç½®æ‘˜è¦:"
        echo "ç›®æ ‡è®¾å¤‡: $(grep "CONFIG_TARGET.*DEVICE.*=y" .config | head -1 || echo 'æœªçŸ¥')"
        
        touch ../.stage_config_complete
        echo "config_ready=true" >> $GITHUB_OUTPUT

    # ==================== ä¸‹è½½é˜¶æ®µ ====================
    - name: ä¸‹è½½è½¯ä»¶åŒ…
      id: download_packages
      if: |
        (steps.create_config.outputs.config_ready == 'true' || 
         steps.init.outputs.resume_point == 'after_download') && 
        !cancelled()
      run: |
        echo "=== é˜¶æ®µ5: ä¸‹è½½è½¯ä»¶åŒ… ==="
        cd openwrt
        
        # æ£€æŸ¥ä¸‹è½½æ ‡è®°
        if [ ! -f "../.stage_download_complete" ]; then
          echo "å¼€å§‹ä¸‹è½½è½¯ä»¶åŒ…..."
          make download -j2 || make download -j1
          
          # éªŒè¯ä¸‹è½½å®Œæ•´æ€§
          echo "ä¸‹è½½æ–‡ä»¶ç»Ÿè®¡:"
          find dl -name "*.gz" -o -name "*.xz" -o -name "*.bz2" | wc -l
          du -sh dl/
          
          touch ../.stage_download_complete
        else
          echo "è½¯ä»¶åŒ…å·²ä¸‹è½½ï¼Œè·³è¿‡ä¸‹è½½é˜¶æ®µ"
        fi
        
        echo "download_complete=true" >> $GITHUB_OUTPUT

    # ==================== å·¥å…·é“¾ç¼–è¯‘é˜¶æ®µ ====================
    - name: ç¼–è¯‘å·¥å…·é“¾
      id: build_toolchain
      if: |
        (steps.download_packages.outputs.download_complete == 'true' || 
         steps.init.outputs.resume_point == 'after_toolchain') && 
        !cancelled()
      run: |
        echo "=== é˜¶æ®µ6: ç¼–è¯‘å·¥å…·é“¾ ==="
        cd openwrt
        
        if [ ! -f "../.stage_toolchain_complete" ]; then
          echo "ç¼–è¯‘å·¥å…·é“¾..."
          make toolchain/compile -j2 || make toolchain/compile -j1 V=s
          touch ../.stage_toolchain_complete
        else
          echo "å·¥å…·é“¾å·²ç¼–è¯‘ï¼Œè·³è¿‡..."
        fi
        
        echo "toolchain_ready=true" >> $GITHUB_OUTPUT

    # ==================== å†…æ ¸ç¼–è¯‘é˜¶æ®µ ====================
    - name: ç¼–è¯‘å†…æ ¸
      id: build_kernel
      if: |
        (steps.build_toolchain.outputs.toolchain_ready == 'true' || 
         steps.init.outputs.resume_point == 'after_kernel') && 
        !cancelled()
      run: |
        echo "=== é˜¶æ®µ7: ç¼–è¯‘å†…æ ¸ ==="
        cd openwrt
        
        if [ ! -f "../.stage_kernel_complete" ]; then
          echo "ç¼–è¯‘å†…æ ¸..."
          make target/linux/compile -j2 || make target/linux/compile -j1 V=s
          touch ../.stage_kernel_complete
        else
          echo "å†…æ ¸å·²ç¼–è¯‘ï¼Œè·³è¿‡..."
        fi
        
        echo "kernel_ready=true" >> $GITHUB_OUTPUT

    # ==================== è½¯ä»¶åŒ…ç¼–è¯‘é˜¶æ®µ ====================
    - name: ç¼–è¯‘è½¯ä»¶åŒ…
      id: build_packages
      if: |
        (steps.build_kernel.outputs.kernel_ready == 'true' || 
         steps.init.outputs.resume_point == 'after_packages') && 
        !cancelled()
      run: |
        echo "=== é˜¶æ®µ8: ç¼–è¯‘è½¯ä»¶åŒ… ==="
        cd openwrt
        
        if [ ! -f "../.stage_packages_complete" ]; then
          echo "ç¼–è¯‘è½¯ä»¶åŒ…..."
          make package/compile -j2 || make package/compile -j1 V=s
          touch ../.stage_packages_complete
        else
          echo "è½¯ä»¶åŒ…å·²ç¼–è¯‘ï¼Œè·³è¿‡..."
        fi
        
        echo "packages_ready=true" >> $GITHUB_OUTPUT

    # ==================== æœ€ç»ˆç¼–è¯‘é˜¶æ®µ ====================
    - name: æœ€ç»ˆç¼–è¯‘å’Œæ‰“åŒ…
      id: final_build
      if: steps.build_packages.outputs.packages_ready == 'true' && !cancelled()
      run: |
        cd openwrt
        
        echo "=== é˜¶æ®µ9: æœ€ç»ˆç¼–è¯‘å’Œæ‰“åŒ… ==="
        echo "ç³»ç»Ÿèµ„æºçŠ¶æ€:"
        free -h
        df -h
        
        # æœ€ç»ˆç¼–è¯‘
        echo "æ‰§è¡Œæœ€ç»ˆç¼–è¯‘..."
        make -j2 || make -j1 V=s || make -j1 V=sc
        
        echo "status=success" >> $GITHUB_OUTPUT
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    # ==================== è¾“å‡ºå¤„ç†é˜¶æ®µ ====================
    - name: æ•´ç†å’ŒéªŒè¯å›ºä»¶
      if: steps.final_build.outputs.status == 'success' && !cancelled()
      run: |
        cd openwrt/bin/targets/mediatek/mt7981/
        echo "=== å›ºä»¶éªŒè¯ ==="
        echo "ç”Ÿæˆçš„å›ºä»¶æ–‡ä»¶:"
        find . -type f \( -name "*.bin" -o -name "*.img" -o -name "*.gz" \) -exec ls -lh {} \;
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV

    - name: ä¸Šä¼ å›ºä»¶åˆ¶å“
      if: steps.final_build.outputs.status == 'success' && !cancelled()
      uses: actions/upload-artifact@v4
      with:
        name: SL3000-å›ºä»¶-${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}/*
        retention-days: 30
        compression-level: 0

    - name: å‘å¸ƒåˆ° GitHub Release
      if: steps.final_build.outputs.status == 'success' && !cancelled()
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        files: ${{ env.FIRMWARE }}/*
        tag_name: sl3000-resume-${{ env.FILE_DATE }}
        name: å¸æ´›SL-3000 æ–­ç‚¹ç»­ä¼ ç‰ˆ
        body: |
          # å¸æ´› SL-3000 ImmortalWrt å›ºä»¶
          
          ğŸš€ **æ–­ç‚¹ç»­ä¼ ç¼–è¯‘å®Œæˆ**
          
          ## ç¼–è¯‘ä¿¡æ¯
          - **ç¼–è¯‘æ¨¡å¼**: æ™ºèƒ½æ–­ç‚¹ç»­ä¼ 
          - **ç¼–è¯‘æ—¶é—´**: ${{ env.FILE_DATE }}
          - **æ¢å¤èµ·ç‚¹**: ${{ github.event.inputs.resume_from }}
          - **è·³è¿‡é—®é¢˜é©±åŠ¨**: ${{ github.event.inputs.skip_problematic }}
          
          ## ç‰¹ç‚¹
          - âœ… æ”¯æŒä»ä»»æ„é˜¶æ®µæ¢å¤ç¼–è¯‘
          - âœ… è‡ªåŠ¨ä¿®å¤å·²çŸ¥ç¼–è¯‘é—®é¢˜
          - âœ… æ™ºèƒ½ç¼“å­˜ç®¡ç†
          - âœ… ç¨³å®šçš„åŸºç¡€åŠŸèƒ½
        draft: false
        prerelease: false

    # ==================== æ¸…ç†å’ŒæŠ¥å‘Šé˜¶æ®µ ====================
    - name: æ¸…ç†é˜¶æ®µæ ‡è®°
      if: always()
      run: |
        echo "=== æ¸…ç†é˜¶æ®µæ ‡è®° ==="
        # ä¿ç•™æ ‡è®°ä»¥ä¾¿ä¸‹æ¬¡ç»­ä¼ ï¼Œåªåœ¨å®Œå…¨æˆåŠŸæ—¶è€ƒè™‘æ¸…ç†
        if [ "${{ steps.final_build.outputs.status }}" = "success" ]; then
          echo "ç¼–è¯‘å®Œå…¨æˆåŠŸï¼Œä¿ç•™é˜¶æ®µæ ‡è®°ä¾›åç»­ä½¿ç”¨"
        else
          echo "ç¼–è¯‘æœªå®Œæˆï¼Œä¿ç•™é˜¶æ®µæ ‡è®°ä»¥ä¾¿ç»­ä¼ "
        fi

    - name: ç”Ÿæˆç¼–è¯‘æŠ¥å‘Š
      if: always()
      run: |
        echo "=== æ™ºèƒ½æ–­ç‚¹ç»­ä¼ ç¼–è¯‘æŠ¥å‘Š ==="
        echo "ğŸ¯ æœ€ç»ˆç»“æœ: ${{ steps.final_build.outputs.status || 'æœªå®Œæˆ' }}"
        echo ""
        echo "ğŸ“Š é˜¶æ®µå®Œæˆæƒ…å†µ:"
        echo "----------------------------------------"
        echo "âœ…  ä¾èµ–å®‰è£…: ${{ steps.install_deps.outputs.deps_ready || 'è·³è¿‡' }}"
        echo "âœ…  æºç ä¿®å¤: ${{ steps.prepare_source.outputs.source_ready || 'è·³è¿‡' }}"
        echo "âœ…  è½¯ä»¶æºé…ç½®: ${{ steps.setup_feeds.outputs.feeds_ready || 'è·³è¿‡' }}"
        echo "âœ…  ç¼–è¯‘é…ç½®: ${{ steps.create_config.outputs.config_ready || 'è·³è¿‡' }}"
        echo "âœ…  è½¯ä»¶åŒ…ä¸‹è½½: ${{ steps.download_packages.outputs.download_complete || 'è·³è¿‡' }}"
        echo "âœ…  å·¥å…·é“¾ç¼–è¯‘: ${{ steps.build_toolchain.outputs.toolchain_ready || 'è·³è¿‡' }}"
        echo "âœ…  å†…æ ¸ç¼–è¯‘: ${{ steps.build_kernel.outputs.kernel_ready || 'è·³è¿‡' }}"
        echo "âœ…  è½¯ä»¶åŒ…ç¼–è¯‘: ${{ steps.build_packages.outputs.packages_ready || 'è·³è¿‡' }}"
        echo "âœ…  æœ€ç»ˆç¼–è¯‘: ${{ steps.final_build.outputs.status || 'æœªå®Œæˆ' }}"
        echo "----------------------------------------"
        echo ""
        if [ "${{ steps.final_build.outputs.status }}" = "success" ]; then
          echo "ğŸ‰ ç¼–è¯‘æˆåŠŸï¼å›ºä»¶å·²ä¸Šä¼ åˆ°åˆ¶å“å’ŒRelease"
        else
          echo "ğŸ’¡ ä¸‹æ¬¡è¿è¡Œå»ºè®®:"
          echo "   å¦‚æœå¤±è´¥åœ¨æŸä¸ªé˜¶æ®µï¼Œä¸‹æ¬¡é€‰æ‹©ä»è¯¥é˜¶æ®µä¹‹åå¼€å§‹"
          echo "   ä¾‹å¦‚: å¦‚æœå·¥å…·é“¾ç¼–è¯‘å¤±è´¥ï¼Œé€‰æ‹© 'after_toolchain'"
          echo "   å½“å‰æ¢å¤ç‚¹: ${{ steps.init.outputs.resume_point }}"
        fi
