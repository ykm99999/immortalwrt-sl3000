name: Build ImmortalWrt SL3000

on:
  workflow_dispatch:   # 手动触发

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
          python3 python3-setuptools rsync unzip zlib1g-dev file wget curl \
          libelf-dev libncurses-dev

    - name: Clone ImmortalWrt
      run: |
        git clone https://github.com/immortalwrt/immortalwrt.git
        cd immortalwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Patch SL3000 device
      run: |
        cd immortalwrt
        # 添加 DTS 文件
        cat > target/linux/mediatek/dts/mt7981-siluo-sl3000.dts <<'EOF'
        /dts-v1/;

        #include "mt7981.dtsi"

        / {
            model = "Siluo SL-3000";
            compatible = "siluo,sl3000", "mediatek,mt7981";

            chosen {
                bootargs = "console=ttyS0,115200n8";
            };

            memory {
                reg = <0x40000000 0x20000000>; /* 示例：512MB RAM */
            };

            aliases {
                led-boot = &led_status;
            };

            leds {
                compatible = "gpio-leds";
                led_status: status {
                    label = "sl3000:green:status";
                    gpios = <&pio 12 GPIO_ACTIVE_HIGH>;
                };
            };
        };
        EOF

        # 修改 mt7981.mk 添加设备定义
        echo '
        define Device/siluo_sl3000
          DEVICE_VENDOR := Siluo
          DEVICE_MODEL := SL-3000
          DEVICE_DTS := mt7981-siluo-sl3000
          DEVICE_PACKAGES := kmod-mt7981-wifi uboot-envtools
        endef
        TARGET_DEVICES += siluo_sl3000
        ' >> target/linux/mediatek/image/mt7981.mk

    - name: Copy custom config
      run: |
        cp sl3000.config immortalwrt/.config

    - name: Verify target config
      run: |
        cd immortalwrt
        grep CONFIG_TARGET_mediatek_mt7981_DEVICE_siluo_sl3000=y .config || (echo "❌ SL3000 未启用！" && exit 1)

    - name: Verify SL3000 patch
      run: |
        test -f immortalwrt/target/linux/mediatek/dts/mt7981-siluo-sl3000.dts || (echo "❌ DTS 文件缺失" && exit 1)
        grep siluo_sl3000 immortalwrt/target/linux/mediatek/image/mt7981.mk || (echo "❌ mt7981.mk 未添加设备定义" && exit 1)

    - name: Build firmware
      run: |
        cd immortalwrt
        make defconfig
        make toolchain/install -j$(nproc) || (echo "❌ 工具链编译失败" && exit 1)
        make -j$(nproc) V=s || (echo "❌ 固件编译失败" && exit 1)

    - name: Verify firmware output
      run: |
        ls immortalwrt/bin/targets/mediatek/mt7981/*sl3000* || (echo "❌ 没有生成 SL3000 固件" && exit 1)

    - name: Upload firmware to Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: SL3000-ImmortalWrt-${{ github.run_number }}
        name: SL3000-ImmortalWrt-${{ github.run_number }}
        draft: false
        prerelease: false
        files: |
          immortalwrt/bin/targets/mediatek/mt7981/*sl3000*.bin
          immortalwrt/bin/targets/mediatek/mt7981/*sl3000*.itb
          immortalwrt/bin/targets/mediatek/mt7981/*.manifest
          immortalwrt/bin/targets/mediatek/mt7981/*.buildinfo
