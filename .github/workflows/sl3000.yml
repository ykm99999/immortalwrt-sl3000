name: Build Siluo SL-3000 ImmortalWrt 24.10 - improved

on:
  workflow_dispatch:

env:
  CCACHE_DIR: ${{ github.workspace }}/ccache }

jobs:
  build:
    name: Build ImmortalWrt MT7981 Siluo SL3000
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    shell: bash

    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/lib/jvm
          df -h

      - name: Checkout ImmortalWrt 24.10 source
        run: |
          git clone https://github.com/immortalwrt/immortalwrt.git openwrt
          cd openwrt
          git checkout openwrt-24.10

      - name: Cache ccache
        uses: actions/cache@v3
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ${{ runner.os }}-ccache-${{ hashFiles('openwrt/.config') }}
          restore-keys: |
            ${{ runner.os }}-ccache-

      - name: Add custom DTS
        run: |
          curl -L https://raw.githubusercontent.com/ykm888/immortalwrt-sl3000/refs/heads/main/target/linux/mediatek/dts/mt7981-siluo-sl3000.dts \
            -o openwrt/target/linux/mediatek/dts/mt7981-siluo-sl3000.dts

      - name: Add custom mk
        run: |
          curl -L https://raw.githubusercontent.com/ykm888/immortalwrt-sl3000/refs/heads/main/target/linux/mediatek/image/mt7981.mk \
            -o openwrt/target/linux/mediatek/image/mt7981.mk

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib \
            g++-multilib gettext git libncurses5-dev libncursesw5-dev libssl-dev python3 \
            python3-setuptools rsync unzip zlib1g-dev file wget ccache cmake libjson-c-dev

      - name: Update feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Configure target
        run: |
          cd openwrt
          rm -f .config
          printf "%s\n" \
            "# 固件目标平台" \
            "CONFIG_TARGET_mediatek=y" \
            "CONFIG_TARGET_mediatek_mt7981=y" \
            "CONFIG_TARGET_mediatek_mt7981_DEVICE_siluo_sl3000=y" \
            "" \
            "# 内核版本" \
            "CONFIG_LINUX_6_6=y" \
            "" \
            "# 镜像格式（保证生成 initramfs 和 sysupgrade）" \
            "CONFIG_TARGET_ROOTFS_INITRAMFS=y" \
            "CONFIG_TARGET_ROOTFS_SQUASHFS=y" \
            "CONFIG_TARGET_IMAGES_GZIP=y" \
            "" \
            "# LuCI 中文界面" \
            "CONFIG_PACKAGE_luci=y" \
            "CONFIG_PACKAGE_luci-i18n-base-zh-cn=y" \
            "CONFIG_PACKAGE_luci-theme-bootstrap=y" \
            "" \
            "# Docker 支持" \
            "CONFIG_PACKAGE_docker=y" \
            "CONFIG_PACKAGE_dockerd=y" \
            "CONFIG_PACKAGE_luci-app-docker=y" \
            "" \
            "# 在线升级" \
            "CONFIG_PACKAGE_luci-app-attendedsysupgrade=y" \
            "CONFIG_PACKAGE_luci-app-opkg=y" \
            "" \
            "# 网络加速" \
            "CONFIG_PACKAGE_luci-app-turboacc=y" \
            "CONFIG_PACKAGE_luci-i18n-turboacc-zh-cn=y" \
            "CONFIG_PACKAGE_kmod-ipt-offload=y" \
            "CONFIG_PACKAGE_kmod-shortcut-fe=y" \
            "CONFIG_PACKAGE_kmod-shortcut-fe-cm=y" \
            "CONFIG_PACKAGE_kmod-nft-fullcone=y" \
            "CONFIG_PACKAGE_kmod-tcp-bbr=y" \
            "" \
            "# Wi-Fi 驱动与无线管理" \
            "CONFIG_PACKAGE_kmod-mt7981-wifi=y" \
            "CONFIG_PACKAGE_luci-app-wireless=y" \
            "CONFIG_PACKAGE_luci-i18n-wireless-zh-cn=y" \
            "CONFIG_PACKAGE_wpad-openssl=y" \
            "CONFIG_PACKAGE_hostapd=y" \
            "CONFIG_PACKAGE_iw=y" \
            "CONFIG_PACKAGE_wireless-tools=y" \
            "" \
            "# 常用工具" \
            "CONFIG_PACKAGE_luci-app-firewall=y" \
            "CONFIG_PACKAGE_luci-app-upnp=y" \
            "CONFIG_PACKAGE_luci-app-samba4=y" \
            "CONFIG_PACKAGE_luci-app-ddns=y" \
            "" \
            "CONFIG_CCACHE=y" \
            > .config
          make defconfig

      - name: Build firmware
        run: |
          cd openwrt
          make -j$(nproc) V=s

      - name: Cleanup build cache
        run: |
          cd openwrt
          rm -rf tmp build_dir staging_dir
          df -h

      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: siluo-sl3000-firmware
          path: openwrt/bin/targets/mediatek/mt7981/*.bin
