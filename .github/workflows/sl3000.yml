name: Build SL-3000 Full Firmware (LuCI Optimized)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout my repo
      uses: actions/checkout@v4

    - name: Aggressive disk cleanup
      run: |
        echo "==== Before cleanup ===="
        df -h

        # 删除常见大目录
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache
        sudo rm -rf /usr/local/share/{boost,powershell,chromium,edge,firefox,gecko_driver,selenium,vcpkg}

        # 清理 apt 缓存和日志
        sudo apt-get clean
        sudo rm -rf /var/lib/apt/lists/* /var/cache/apt/* /var/log/*

        # 删除 docker 镜像和缓存
        sudo docker system prune -af || true

        # 删除临时文件
        sudo rm -rf /tmp/*

        echo "==== After cleanup ===="
        df -h

    - name: Checkout ImmortalWrt source
      run: |
        git clone https://github.com/immortalwrt/immortalwrt.git
        cd immortalwrt
        git checkout openwrt-24.10

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential flex bison gettext libncurses5-dev libssl-dev \
          python3 python3-distutils unzip file wget rsync libelf-dev ccache

    - name: Add custom DTS & mk
      run: |
        # 下载 DTS 文件到内核目录
        curl -L -o immortalwrt/target/linux/mediatek/files-6.6/arch/arm64/boot/dts/mediatek/mt7981-siluo-sl3000.dts \
          https://raw.githubusercontent.com/ykm99999/immortalwrt-sl3000/refs/heads/main/target/linux/mediatek/dts/mt7981-siluo-sl3000.dts

        # 下载 mk 文件到 image 目录
        curl -L -o immortalwrt/target/linux/mediatek/image/mt7981.mk \
          https://raw.githubusercontent.com/ykm99999/immortalwrt-sl3000/refs/heads/main/target/linux/mediatek/image/mt7981.mk

    - name: Configure target (full firmware + LuCI)
      run: |
        cd immortalwrt
        echo "CONFIG_TARGET_mediatek=y" > .config
        echo "CONFIG_TARGET_mediatek_mt7981=y" >> .config
        echo "CONFIG_TARGET_mediatek_mt7981_DEVICE_siluo_sl3000=y" >> .config
        echo "CONFIG_LINUX_6_6=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_INITRAMFS=y" >> .config
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        echo "CONFIG_TARGET_IMAGES_GZIP=y" >> .config
        echo "CONFIG_PACKAGE_base-files=y" >> .config
        echo "CONFIG_PACKAGE_busybox=y" >> .config
        echo "CONFIG_PACKAGE_opkg=y" >> .config
        echo "CONFIG_PACKAGE_dropbear=y" >> .config
        echo "CONFIG_PACKAGE_dnsmasq-full=y" >> .config
        echo "CONFIG_PACKAGE_netifd=y" >> .config
        echo "CONFIG_PACKAGE_ip-full=y" >> .config
        echo "CONFIG_PACKAGE_kmod-mt7981-wifi=y" >> .config
        echo "CONFIG_PACKAGE_wpad-openssl=y" >> .config
        echo "CONFIG_PACKAGE_hostapd=y" >> .config
        echo "CONFIG_PACKAGE_iw=y" >> .config
        echo "CONFIG_PACKAGE_wireless-tools=y" >> .config
        echo "CONFIG_CCACHE=y" >> .config
        # LuCI Web 界面
        echo "CONFIG_PACKAGE_luci=y" >> .config
        echo "CONFIG_PACKAGE_luci-base=y" >> .config
        echo "CONFIG_PACKAGE_luci-mod-admin-full=y" >> .config
        echo "CONFIG_PACKAGE_luci-theme-bootstrap=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-opkg=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-wireless=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-base-zh-cn=y" >> .config
        echo "CONFIG_PACKAGE_luci-i18n-wireless-zh-cn=y" >> .config
        make defconfig

    - name: Build firmware (full)
      run: |
        cd immortalwrt
        echo "==== Disk usage before build ===="
        df -h
        make -j$(nproc) || make -j1 V=s
        echo "==== Disk usage after build ===="
        df -h

    - name: Upload initramfs image
      uses: actions/upload-artifact@v4
      with:
        name: sl3000-initramfs
        path: immortalwrt/bin/targets/*/*/*initramfs*.bin

    - name: Upload squashfs image
      uses: actions/upload-artifact@v4
      with:
        name: sl3000-squashfs
        path: immortalwrt/bin/targets/*/*/*squashfs*.bin

    - name: Cleanup build_dir and staging_dir after success
      if: success()
      run: |
        rm -rf immortalwrt/build_dir immortalwrt/staging_dir immortalwrt/tmp
        echo "==== Disk usage after cleanup ===="
        df -h

    - name: Show last 200 lines of build log if failed
      if: failure()
      run: |
        echo "==== Build failed, showing last 200 lines of log ===="
        tail -n 200 immortalwrt/build.log || true
