name: "司络SL-3000 EMMC 固件编译"

on:
  workflow_dispatch:

permissions:
  contents: write

env:
  REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x-24.10
  REPO_BRANCH: 2410
  CONFIG_FILE: sl3000.config
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Init environment (CMake>=3.31 + Ninja + Meson)
      shell: bash
      run: |
        set -euxo pipefail
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/lib/jvm /opt/hostedtoolcache/CodeQL
        sudo docker image prune --all --force || true

        sudo -E apt-get -qq update
        sudo -E apt-get -qq install -y \
          build-essential git wget curl unzip rsync file \
          python3 python3-pip python3-setuptools python3-venv \
          libncurses5-dev libncursesw5-dev swig libseccomp-dev gawk flex gettext \
          libssl-dev zlib1g-dev software-properties-common lsb-release \
          ninja-build pkg-config meson

        # 安装 CMake 3.31+（Kitware）并用 pip 双保险
        sudo apt-get remove -y cmake || true
        sudo apt-add-repository -y 'deb https://apt.kitware.com/ubuntu/ jammy main'
        wget -O - https://apt.kitware.com/keys/kitware-archive-latest.asc | sudo apt-key add -
        sudo apt-get update
        sudo apt-get install -y cmake || true

        python3 -m pip install --upgrade --user cmake
        echo 'export PATH="$HOME/.local/bin:$PATH"' >> "$GITHUB_ENV"
        export PATH="$HOME/.local/bin:$PATH"

        cmake --version
        ninja --version || true
        meson --version || true

    - name: Clone source code
      shell: bash
      run: |
        set -eux
        git clone --depth=1 "$REPO_URL" -b "$REPO_BRANCH" openwrt
        test -f openwrt/include/toplevel.mk || { echo "ERROR: source clone failed"; exit 1; }

    - name: Write feeds.conf.default
      shell: bash
      run: |
        set -eux
        cat > openwrt/feeds.conf.default << 'EOF'
        src-git packages https://github.com/immortalwrt/packages.git;master
        src-git luci https://github.com/immortalwrt/luci.git;master
        src-git routing https://github.com/openwrt-routing/packages.git;openwrt-23.05
        src-git telephony https://github.com/openwrt/telephony.git;openwrt-23.05
        src-git passwall2 https://github.com/xiaorouji/openwrt-passwall2.git;main
        EOF

    - name: Vendor TurboACC
      shell: bash
      run: |
        set -eux
        mkdir -p openwrt/package/community
        git clone --depth=1 https://github.com/chenmozhijin/turboacc.git /tmp/turboacc
        cp -r /tmp/turboacc/luci-app-turboacc openwrt/package/community/luci-app-turboacc

    - name: Update & install feeds
      shell: bash
      run: |
        set -eux
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Deep clean (existence-safe)
      shell: bash
      run: |
        set -eux
        # 仅当目录存在时才进入
        if [ -d openwrt/package/feeds/packages ]; then
          cd openwrt/package/feeds/packages
          # 移除依赖 Python/Rust/Perl 的包（避免 "does not exist"）
          for d in speedtest-cli supervisor tdb text-unidecode tunneldigger-broker \
                   unbound uwsgi vectorscan vobject wakeonlan whois xtables-addons \
                   ykdl you-get yt-dlp spotifyd yggdrasil-jumper tuic-client tuic-server; do
            [ -d "$d" ] && rm -rf "$d"
          done
          # 扫描并删掉所有 python* 包目录
          for p in $(ls -1 | grep -E '^python' || true); do
            [ -d "$p" ] && rm -rf "$p"
          done
          # Perl 相关
          for p in perl perl-ack perl-authen-sasl perl-authen-sasl-xs perl-cgi perl-class-inspector perl-clone \
                   perl-compress-bzip2 perl-dbi perl-device-serialport perl-device-usb perl-encode-locale \
                   perl-file-listing perl-file-next perl-file-rsyncp perl-file-sharedir perl-file-sharedir-install \
                   perl-future perl-future-asyncawait perl-html-form perl-html-parser perl-html-tagset perl-html-tree \
                   perl-http-cookies perl-http-daemon perl-http-date perl-http-message perl-http-negotiate \
                   perl-http-server-simple perl-inline perl-inline-c perl-io-async perl-io-async-ssl perl-io-html \
                   perl-io-socket-ssl perl-lockfile-simple perl-lwp-mediatypes perl-lwp-protocol-https \
                   perl-mail-spamassassin perl-metrics-any perl-net-async-http perl-net-cidr-lite perl-net-dns \
                   perl-net-dns-sec perl-net-http perl-net-ssleay perl-net-telnet perl-netaddr-ip perl-parse-recdescent \
                   perl-parse-yapp perl-struct-dumb perl-sub-uplevel perl-test-harness perl-test-warn perl-text-csv_xs \
                   perl-time-moment perl-try-tiny perl-uri perl-www perl-www-curl perl-www-mech; do
            [ -d "$p" ] && rm -rf "$p"
          done
        fi

        # utils/usbgadget 存在才删
        if [ -d openwrt/package/utils/usbgadget ]; then
          rm -rf openwrt/package/utils/usbgadget
        fi

        # telephony 目录存在才删 yate
        if [ -d openwrt/package/feeds/telephony ]; then
          if [ -d openwrt/package/feeds/telephony/yate ]; then
            rm -rf openwrt/package/feeds/telephony/yate
          fi
        fi

    - name: Prepare .config
      shell: bash
      run: |
        set -eux
        [ -f "$CONFIG_FILE" ] && cp "$CONFIG_FILE" openwrt/.config || echo "WARNING: no $CONFIG_FILE, using defaults"
        cd openwrt
        make defconfig
        grep -E '^CONFIG_TARGET_mediatek_mt7981_DEVICE_sl_3000-emmc=y' .config || { echo "ERROR: target not selected"; exit 1; }

    - name: Build full host tools (then override cmake to 3.31+ and PATH)
      shell: bash
      run: |
        set -eux
        cd openwrt
        # tools 阶段先完整安装，再覆盖 cmake
        make tools/install -j1 V=s

        host_bin="$PWD/staging_dir/host/bin"
        mkdir -p "$host_bin"
        sys_cmake="$(command -v cmake)"
        test -x "$sys_cmake" || { echo "ERROR: system cmake not found"; exit 1; }
        ln -sf "$sys_cmake" "$host_bin/cmake"
        "$host_bin/cmake" --version

        # 确保后续统一优先使用 host/bin 的 cmake
        echo "export PATH=\"$host_bin:\$PATH\"" >> "$GITHUB_ENV"

    - name: Download packages
      shell: bash
      run: |
        set -eux
        cd openwrt
        make download -j8
        find dl -size -1024c -exec rm -f {} \;

    - name: Compile firmware
      shell: bash
      run: |
        set -euxo pipefail
        cd openwrt
        if ! make -j"$(nproc)"; then
          make -j1 V=s
        fi

    - name: Collect firmware
      shell: bash
      run: |
        set -eux
        if [ -d openwrt/bin/targets ] && [ "$(find openwrt/bin/targets -type f | wc -l)" -gt 0 ]; then
          cd openwrt/bin/targets/*/*
          rm -rf packages
          echo "FIRMWARE=$PWD" >> "$GITHUB_ENV"
        else
          echo "ERROR: No firmware files found"
          exit 1
        fi

    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: "SL3000_firmware"
        path: ${{ env.FIRMWARE }}

    - name: Release firmware
      uses: softprops/action-gh-release@v2.1.0
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        files: ${{ env.FIRMWARE }}/*
        name: "司络SL-3000 EMMC"
        tag_name: ${{ github.run_id }}
        body: "司络SL-3000 EMMC 固件编译完成 ✅\n编译时间: $(date)\n设备: SL-3000 (MT7981, EMMC)"
