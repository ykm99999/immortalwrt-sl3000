name: "司络SL-3000 EMMC 分步体检编译"

on:
  workflow_dispatch:

permissions:
  contents: write

env:
  REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x-24.10
  REPO_BRANCH: 2410
  CONFIG_FILE: sl3000.config
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: "Checkout"
      uses: actions/checkout@v4

    - name: "Initialization environment"
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/lib/jvm /opt/hostedtoolcache/CodeQL
        sudo docker image prune --all --force
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install build-essential git wget curl unzip rsync file \
          python3 python3-pip python3-setuptools python3-venv \
          libncurses5-dev libncursesw5-dev swig libseccomp-dev gawk flex gettext \
          libssl-dev zlib1g-dev
        sudo apt-get clean
        df -hT

    - name: "Clone source code"
      run: |
        git clone --depth=1 "$REPO_URL" -b "$REPO_BRANCH" openwrt
        test -f openwrt/include/toplevel.mk || { echo "ERROR: source clone failed"; exit 1; }

    - name: "Write feeds.conf.default"
      run: |
        cat > openwrt/feeds.conf.default << 'EOF'
        src-git packages https://github.com/immortalwrt/packages.git;master
        src-git luci https://github.com/immortalwrt/luci.git;master
        src-git routing https://github.com/openwrt-routing/packages.git;openwrt-23.05
        src-git telephony https://github.com/openwrt/telephony.git;openwrt-23.05
        src-git passwall2 https://github.com/xiaorouji/openwrt-passwall2.git;main
        EOF
        cat openwrt/feeds.conf.default

    - name: "Vendor TurboACC (chenmozhijin/turboacc)"
      run: |
        mkdir -p openwrt/package/community
        git clone --depth=1 https://github.com/chenmozhijin/turboacc.git /tmp/turboacc
        cp -r /tmp/turboacc/luci-app-turboacc openwrt/package/community/luci-app-turboacc
        test -d openwrt/package/community/luci-app-turboacc || { echo "ERROR: TurboACC vendor failed"; exit 1; }

    - name: "Update feeds"
      run: |
        cd openwrt
        ./scripts/feeds update -a

    - name: "Install feeds"
      run: |
        cd openwrt
        ./scripts/feeds install -a

    - name: "Preflight scan deprecated deps"
      run: |
        cd openwrt
        (grep -R --line-number -E 'libcrypt-compat|libxcrypt|libpcre|kmod-usb-gadget-ncm|kmod-crypto-chacha20poly1305|python3-distutils|python3-light|python3-urllib|python3-email|python3-uuid|python3-logging|python3-multiprocessing|python3-pydoc' package/feeds || true) | tee ../deprecated_deps_scan.txt

    - name: "Upload preflight scan"
      uses: actions/upload-artifact@v4
      with:
        name: "preflight_scan"
        path: "deprecated_deps_scan.txt"

    - name: "Comprehensive clean: broken and Python packages"
      run: |
        cd openwrt/package/feeds/packages
        # 已知旧依赖包
        rm -rf ovpn-dco strongswan usbgadget sudo tac_plus tcsh ufp uw-imap xinetd xupnpd perl rtty samba4 screen shadow squid stress-ng || true
        # Python 全生态（避免解析到不存在的 python3-* 拆分）
        ls -1 | grep -E '^python' | xargs -I{} rm -rf "{}" || true
        # telephony 旧依赖
        cd ../telephony
        rm -rf rtpengine sipgrep || true

    - name: "Copy config & defconfig"
      run: |
        [ -f "$CONFIG_FILE" ] && cp "$CONFIG_FILE" openwrt/.config || echo "WARNING: no $CONFIG_FILE, will use defaults"
        cd openwrt
        test -f include/toplevel.mk || { echo "ERROR: not in openwrt top-level"; exit 1; }
        make defconfig
        echo "==== Target check ===="
        grep -E '^CONFIG_TARGET_mediatek_mt7981_DEVICE_sl_3000-emmc=y' .config || { echo "ERROR: SL-3000 EMMC not selected"; exit 1; }
        echo "==== Bad selections check (Python & deprecated) ===="
        (grep -E 'CONFIG_PACKAGE_(ovpn-dco|strongswan|usbgadget|sudo|tac_plus|tcsh|ufp|uw-imap|xinetd|xupnpd|perl|rtty|samba4|screen|shadow|squid|stress-ng|rtpengine|sipgrep|python.*)=y' .config || true) | tee ../bad_selections.txt

    - name: "Upload bad selections"
      uses: actions/upload-artifact@v4
      with:
        name: "bad_selections"
        path: "bad_selections.txt"

    - name: "Proceed only with defconfig (remove olddefconfig)"
      run: |
        cd openwrt
        # 用 defconfig 即可，不再调用 olddefconfig（该源不支持）
        echo "Defconfig complete."

    - name: "Download packages"
      run: |
        cd openwrt
        make download -j8
        find dl -size -1024c -exec rm -f {} \;

    - name: "Compile firmware"
      run: |
        cd openwrt
        set -o pipefail
        if ! make -j"$(nproc)"; then
          make -j1 V=s
        fi

    - name: "Organize files"
      run: |
        if [ -d openwrt/bin/targets ] && [ "$(find openwrt/bin/targets -type f | wc -l)" -gt 0 ]; then
          cd openwrt/bin/targets/*/*
          rm -rf packages
          echo "FIRMWARE=$PWD" >> "$GITHUB_ENV"
        else
          echo "ERROR: No firmware files found"
          exit 1
        fi

    - name: "Upload firmware"
      uses: actions/upload-artifact@v4
      with:
        name: "SL3000_firmware"
        path: ${{ env.FIRMWARE }}

    - name: "Release firmware"
      uses: softprops/action-gh-release@v2.1.0
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        files: ${{ env.FIRMWARE }}/*
        name: "司络SL-3000 EMMC"
        tag_name: ${{ github.run_id }}
        body: "司络SL-3000 EMMC 固件编译完成 ✅\n编译时间: $(date)\n设备: SL-3000 (MT7981, EMMC)"
