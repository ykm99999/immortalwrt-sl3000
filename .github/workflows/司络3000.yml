name: "司络SL-3000 EMMC 固件编译"

on:
  workflow_dispatch:

permissions:
  contents: write

env:
  REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x-24.10
  REPO_BRANCH: 2410
  CONFIG_FILE: sl3000.config
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Init environment (CMake>=3.31 + Ninja + Meson)
      shell: bash
      run: |
        set -euxo pipefail
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/lib/jvm /opt/hostedtoolcache/CodeQL
        sudo docker image prune --all --force || true
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install -y \
          build-essential git wget curl unzip rsync file \
          python3 python3-pip python3-setuptools python3-venv \
          libncurses5-dev libncursesw5-dev swig libseccomp-dev gawk flex gettext \
          libssl-dev zlib1g-dev software-properties-common lsb-release ninja-build pkg-config meson
        sudo apt-get remove -y cmake || true
        sudo apt-add-repository -y 'deb https://apt.kitware.com/ubuntu/ jammy main'
        wget -O - https://apt.kitware.com/keys/kitware-archive-latest.asc | sudo apt-key add -
        sudo apt-get update && sudo apt-get install -y cmake || true
        python3 -m pip install --upgrade --user cmake meson
        echo 'export PATH="$HOME/.local/bin:$PATH"' >> "$GITHUB_ENV"
        export PATH="$HOME/.local/bin:$PATH"
        cmake --version
        meson --version
        ninja --version

    - name: Clone source code
      run: |
        git clone --depth=1 "$REPO_URL" -b "$REPO_BRANCH" openwrt
        test -f openwrt/include/toplevel.mk || { echo "ERROR: source clone failed"; exit 1; }

    - name: Write feeds.conf.default
      run: |
        cat > openwrt/feeds.conf.default << 'EOF'
        src-git packages https://github.com/immortalwrt/packages.git;master
        src-git luci https://github.com/immortalwrt/luci.git;master
        src-git routing https://github.com/openwrt-routing/packages.git;openwrt-23.05
        src-git telephony https://github.com/openwrt/telephony.git;openwrt-23.05
        src-git passwall2 https://github.com/xiaorouji/openwrt-passwall2.git;main
        EOF

    - name: Vendor TurboACC
      run: |
        mkdir -p openwrt/package/community
        git clone --depth=1 https://github.com/chenmozhijin/turboacc.git /tmp/turboacc
        cp -r /tmp/turboacc/luci-app-turboacc openwrt/package/community/luci-app-turboacc

    - name: Update feeds
      run: cd openwrt && ./scripts/feeds update -a

    - name: Install feeds
      run: cd openwrt && ./scripts/feeds install -a

    - name: Clean legacy, Python, Rust
      run: |
        cd openwrt/package/feeds/packages
        rm -rf rtty samba4 screen shadow squid stress-ng usbgadget sudo tac_plus tcsh uw-imap xinetd xupnpd perl ovpn-dco strongswan ufp || true
        ls -1 | grep -E '^python' | xargs -I{} rm -rf "{}" || true
        rm -rf rust || true
        cd ../telephony
        rm -rf sipgrep rtpengine || true

    - name: Load config & defconfig
      run: |
        [ -f "$CONFIG_FILE" ] && cp "$CONFIG_FILE" openwrt/.config || echo "WARNING: no $CONFIG_FILE, using defaults"
        cd openwrt
        make defconfig
        grep -E '^CONFIG_TARGET_mediatek_mt7981_DEVICE_sl_3000-emmc=y' .config || { echo "ERROR: target not selected"; exit 1; }

    - name: Download packages
      run: |
        cd openwrt
        make download -j8
        find dl -size -1024c -exec rm -f {} \;

    - name: Compile firmware
      run: |
        cd openwrt
        set -o pipefail
        if ! make -j"$(nproc)"; then
          make -j1 V=s
        fi

    - name: Collect firmware
      run: |
        if [ -d openwrt/bin/targets ] && [ "$(find openwrt/bin/targets -type f | wc -l)" -gt 0 ]; then
          cd openwrt/bin/
